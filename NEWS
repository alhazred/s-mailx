S - n a i l  N e w s
====================

- The ~@ tilde escape, when given filename arguments, will treat the
  arguments as a comma-separated instead of a whitespace-separated list.
  (collect: change separator of ~@ tilde escape.., 2012-12-28)

- Thanks to Gianluca Ramunno (ramunno DOT gianluca AT gmail DOT com)
  S-Nail will no longer try to issue a STARTTLS command when it is about
  to establish a SMTPS connection, a task that logically fails since the
  connection is already secured.
  (Interestingly the nail codebase performs the necessary test for IMAP
  and POP3 already.)
  While here the undocumented nail v11.0 *smtp-use-tls* legacy option
  has been removed.
  (Fix SMPTS with a set *smtp-use-starttls*.., 2012-12-22)

- The RFC 4155 compliant MBOX quoting is now exclusively used, the
  shitty *posix-mbox* variable has been removed again.
  (Shitty because i've implemented RFC 4155 compliant MBOX quoting and
  tested it, then added *posix-mbox* for those who liked the old
  behaviour and did not re-test -- the final code path was buggy.)

  In mails newly created and saved by S-nail(1) no From_ quoting at all
  will be used no more, but instead the rewritten MIME file classifier
  will detect unquoted From_ lines and enforce quoted-printable encoding.
  (This is an approach that is S/MIME compatible all through the way as
  the file data is not modified at all, but only encoded, so that the
  data checksum is not changed.)

  In yet existent mails that S-nail copies or moves around without
  reclassification an RFC 4155 compliant From_ line detector will apply
  MBOXO quoting (prepend a single '>') as necessary.
  Different to the old MBOXRD behaviour S-nail will neither quote yet
  quoted From_ lines ('>>From xy' -> '>>>From xy') nor will it unquote
  one quote level when reading etc. mails ('>> From xy' -> '>From xy').
  As a result the code could be simplified.

  This changeset also incorporates a fix for NetBSD PR bin/47453, as
  reported by Martin Brandenburg.  I.e., some mailers, noticeably
  UW-imap (with MBX format only?), use non-compliant From_ lines with
  RFC 822 date specifications.  Be aware of 'em.
  (RFC 4155 MBOX, and drop *posix-mbox* and foldergets().., 2013-01-06)

- *rfc822-show-all* has been removed.
  It didn't work properly for more complex MIME structures, like
  message/rfc822 messages with attachments etc., just as i've seen today
  on the file(1) mailing list.
  So, instead of hacking it now i've dropped it and will come back with
  a better solution when the MIME and send layers have been overhauled.
  I.e., the real intent was to be able to specify that an embedded
  message/rfc822 is treated as a *unity*, and that's the goal.
  (Drop *rfc822-show-all*, 2013-01-23)
  [The manual will be adjusted in a different commit.]

- *rfc822-no-body-from_* has been renamed to *rfc822-body-from_*.
  It thus must be set explicitly.
  On the other hand it now catches all cases...
  (*rfc822-no-body-from_* -> *rfc822-body-from_*, 2013-01-23)
  [The manual will be adjusted in a different commit.]

- The new *charset-7bit* (defaults to US-ASCII) and *charset-8bit*
  (defaults to UTF-8) have been introduced.
  These are used if seven bit clean data is to be sent, and no
  *sendcharsets* are set or the convertion of all of them failed,
  respectively:

  - There is no functional change unless there is iconv(3) support.
  - There is no functional change unless you set them.
  (Introduce *charset-8bit* and *charset-7bit* variables.., 2013-01-18)
  [The manual will be adjusted in a different commit.]

  In addition the new *sendcharsets-else-ttycharset* variable can now be
  used to automatically use *ttycharset* as a *sendcharset(s)*,
  regardless of the new *charset-8bit* variable.
  (Add *sendcharsets-else-ttycharset* variable, 2013-01-24)
  [The manual will be adjusted in a different commit.]

  Please reread the manual section "Character sets".

- An attempt was made to improve MIME Content-XY: detection.
  It should be more RFC compliant, and just overall better :);
  a simple one-pass classifier cannot match libmagic(3), of course.

  This changeset removes support of the long obsoleted (4fee1ef,
  2005-01-06) *charset* variable, as well as for the
  *maximum-unencoded-line-length* variable that has been introduced in
  (48a652bd, 2005-07-26).

  For S-nail v14.0 it'll be no longer necessary to do

    $ tr -d '\015' < input | s-nail ...

  to transport files which use the $-DOS (terminal) newline (sequence).
  We still depend upon *sendcharsets* for a while, though.
  (Rewrite file-content classification.., 2013-01-02)

- The new *mime-counter-evidence* variable can be used to force
  a classification of non-text MIME parts (attachments) by their
  filename, i.e., a "reverse-classification" just as would be performed
  if S-nail(1) would itself *send* the file(name).  This can help
  against some stupid MUAs (Apple Mail?) that send .diff etc. files as
  `application/octet-stream' parts etc.

  At a later time this may become a valued option, causing a temporary
  save of unnamed attachments followed by a MIME classification of the
  file contents, followed by forced treatment as plain text if it seems
  to be human readable.  But not yet.  Just to warn you.
  (Add *mime-counter-evidence* variable.., 2012-12-29)

- The special "pipe-" command "@" can be used to force treatment of
  a MIME message part as plain text (e.g.,
  'set pipe-application/pgp-signature=@' will henceforth print those
  signatures inline and as plain text).
  (Introduce the special "@" "pipe-" command, 2012-12-27)

- The MIME types (as from mime.types(5)) will now be cached.  Before
  all possible sources would have been opened, read and parsed for each
  and every message part that required detection of the MIME
  Content-Type:.
  The new "mimetypes" command can be used to show or clear that cache.
  (Add mime.types(5) cache.., 2012-12-27)

- A small set of MIME types (template: ./mime.types) will now become
  compiled into S-nail(1), and be used as a fallback if there are no
  ~/.mime.types and/or no /etc/mime.types, or those didn't contain
  a matching type.  E.g., NetBSD 6 doesn't ship a default database.
  Also, file extensions will be matched case-insensitively (case of
  attribute values is not specified afaik?).
  (Introduce compiled-in mime.types(5).., 2012-12-21)

- The undocumented *charset7* variable was removed.

- The "Message X:" display leader has been changed and will henceforth
  appear like "[Message -- X lines, Y bytes]:".
  These lines can no longer be suppressed by setting the *quiet*
  option (which was yet possible for print and top, though undocumented).
  (Change "Message X:" display message.., 2012-12-20)

- When displaying multipart messages the "Part X:" introductional string
  has been changed; if the Content-type: header is not *retain*ed, then
  this string will include the part's type and size.  Ditto for
  Content-disposition: and a mentioned attachment filename.
  This is a first step only, for the final version the MIME and send
  layers will have to be adjusted.  But the string will be matchable via
  a "^[-- #.* --]$" regular expression from now on.
  (Change "Part X:" display message.., 2012-12-20)

- MIME boundaries in multipart messages are now handled better in that
  no boundary string should get through to the display.
 (Tweak MIME boundary detection.., 2012-12-20)

- A couple of long standing, even pre-Heirloom mailx(1) memory leaks and
  segmentation violations, most of them related to configurations
  without alloca(3) support, as well as one leak that i have introduced
  when i implemented RFC 4155 MBOX handling, have been fixed.
  But S-nail should now survive non-alloca(3) configurations.
  (*memtracer* topic branch.)

- The Base64 MIME handling has been rewritten completely.
  This was an urgent topic, because the old implementation (a) read in
  all lines of a base64 encoded text part, repeatedly resizing a string
  storage until all the lines have been swallowed, (b) used function
  local static data to keep state in between multiple invocations, which
  messed up multibyte encodings like this

    �5��ɽ���Aɥ����́��٥��������[lots of data follows]

  and (c) did not perform any error checking at all.
  The new one does not run into the problem that (a) tried to circumvent
  since leftover decoded data (as opposed to leftover *encoded* data) is
  transported along the call-chain for later use.  It adds a minimal set
  of error handling ('may now see "[Invalid Base64 encoding ignored]"),
  with more to become possible in later S-nail versions when the entire
  layers are reworked.  Base64 encoded lines will now be 76 characters
  long, as stated in RFC 2045, not 72 as before.

  The Base64 code core has been shamelessly stolen from NetBSD's
  Mail(1), and i guess it was the second time that this happened :=).
  (*base64-rewrite* topic branch.)

- The string allocation strategy has been tweaked some more to, i think,
  a final version (regarding algorithm).
  In normal non-interactive send mode it should now no longer need any
  dynamic memory at all (unless some dozen recipients are specified).
  (Several other places still use normal dynamic memory, of course.)
  (*dope-stringdope-again* topic branch.)

- Support for NSS (Network Security Services) has been removed.
  I've never worked with it and are, regarding the complexity of
  network security, not willing to spend any time on it.
  SSL is installed on all systems i'm using and/or testing on by
  default, and so i've choosen to go this way.
  (It may be that sometime in the future S-nail will add support for
  libcurl(3) connectivity, and then it may happen that not only NSS
  support is reintroduced again, but also GNU TLS.  All of that applies
  to network connectivity only, however, not to S/MIME afaik.)
  (*drop-nss-support* topic branch.)

- I finally got a glue and understood that Sourceforge does (a) not
  support symbolic links and (b) doesn't like dots as regular parts of
  filenames.  This means that all this time the promised s-nail.tar.gz
  symbolic link did not work, and that s-nailv13.3.tar.gz wasn't
  accessible either (via the web interface).
  In the future S-nail(1) will not provide any more symbolic links (the
  Sourceforge website offers a "download latest" thing which seems to
  work), and use underscores in filenames -- s-nailv13.3.tar.gz has been
  renamed to s-nailv13_3.tar.gz.  The tags continue to use dot notation.
  Thanks.

- The *heirloom-plus* support branch has been removed.
  The code bases diverged a lot and even more to come.
  It doesn't make sense to put any effort in that.

v13.3, 2012-11-11
-----------------

- Configuration on UnixWare 7.1.4 will succeed (shell issue fixed).

- Even on DragonFly BSD the IMAP GSSAPI is now found
  (in /usr/pkg/include/krb5/gssapi/gssapi.h).

- Support for pkgsrc(7) systems and automatic integration of
  C_INCLUDE_PATH and LD_LIBRARY_PATH path configurations.
  Please see INSTALL.

- Fixes a mortally embarassing regression that the current maintainer
  introduced before i really knew what i was doing, in (If *record* is
  set, avoid writing dead content twice.., 2012-09-14).
  It hit users that send through a MTA and have *record* set; in this
  combination data would not have reached the MTA.
  Interested parties may read the comment in savedeadletter() (part of
  the changeset) or the (Fix MTA/*record* descriptor clash..,
  2012-11-10) commit log.

  Deepest apologies to tortured users from the current maintainer!

- RFC 4155 compatible MBOX file handling has been introduced, and so
  S-nail is now on par with (at least) NetBSD Mail in respect to this.
  It can be turned off with the new *posix-mbox* variable, which you may
  need to use since not all MUAs are capable to dig those MBOX files.
  E.g., less cutting-edge (.-) MUAs fail for this:

   |From - Thu May 10 20:40:54 2012
   |Date: Wed, 07 Nov 2012 11:48:30 +0100
   |To: super@duper.com
   |Subject: super1
   |
   |From me.
   |
   |From - Thu May 10 20:40:54 2012
   |Date: Wed, 07 Nov 2012 11:48:30 +0100
   |To: super@duper.com
   |Subject: super2
   |
   |>From - Thu May 10 20:40:54 2012
   |From - Thu May 10 20:40:54 2012

  I'm not completely happy since S-nail *does* still quote those lines,
  how rare they may be -- it *does* modify message content.  mutt(1)
  implements something more clever and that is quoted-printable encoding
  of the "F" from "From", when seen at the beginning of a line.
  This, when applied to just *any* "^From", will be a non-modifying and
  all-compatible solution.

- SEND_MBOX handling has been changed to discard any Content-Length: and
  Lines: headers when it rewrites a message by default.
  I know that mutt(1) generates them (why, after
  http://www.jwz.org/doc/content-length.html?).
  Anyway, S-nail does neither use nor manage them, so that any
  modification renders those fields invalid, and then it seems best to
  discard them anyway.
  You may turn the new behaviour off with *keep-content-length*.

v13.2, 2012-11-03
-----------------

The problem was that i really wanted to release on a 25th.
But i have been able to improve S-nail(1) some more, so that this is
possibly the first real release of it.  So i'll add only things that
have changed since v13 -- please see below for the complete picture.

- A new CONFIG=CUSTOM make directive was added, and the new user.conf
  variables WANT_SCORE and WANT_DOCSTRINGS have been added.  It is
  possible to create a floating-point free S-nail(1) now.
  Please see INSTALL.

- If a feature is disabled not even functions stubs should remain now.

- Many places which will work only with local filenames do now actually
  check that the target is a local filename.

- Space-separated lists should work again, at a few places at least.

- Tilde commands will be possible, even with -r.

- The *sendmail-progname* has been added after NetBSD 6 dropped the
  send-mail entry in mailer.conf(5), which broke S-nail(1).  Now users
  have an option.

- When editing messages via ~e or ~v file and pipe addressees will no
  longer be lost.

- If recipients occur multiple times spread over lists, i.e., To:, Cc:,
  Bcc:, then only one occurrence remains, and in the "highest-order"
  list.

- The "list" command prints the list alphabetically sorted (somewhat).

- The "help" and "?" commands take an optional argument that shows
  a synopsis string for the given command (unless WANT_DOCSTRINGS was
  false).

- String allocations are now more efficient.  The situation can still be
  improved.  However, for the first time Berkeley Mail(1) integrates
  harmonically into the system allocator, which may madvise(2) unused
  memory to the operating system as necessary and/or possible!

v13.1, 2012-10-25
-----------------

Well, a version number 13 is anyway an ugly thing...

  commit 4f534bb33b7c911272cc66a0e3a9e47b73ad8deb
  Date:   2012-10-25 20:46:07 +0200

      FIX MIME quoted-printable encoding (char cast)..
      
      (;-{
      Auauauauau!!
      
      Well, one of the things that have already been started in v13 is
      the turn from using "int" when working with 8-bit characters to
      "unsigned char" (and as long as we do not support wide
      characters).
      
      Unfortunately one very important piece of code, that is handling
      encoding to quoted-printable, still used integer instead of
      unsigned char, which caused an automatic extension cast to take
      place, and that resulted in a messed up output.
      Sorry!

v13, 2012-10-25
---------------

I want to give prominence to the following people that helped to improve
S-nail(1) during this development cycle, in order of appearance: Martin
Neitzel, Ezequiel Garzón, Björn Persson, Paul Vojta, and, especially,
John Dodson for warm words from beautiful Australia!  Many thanks also
to Christos Zoulas.

After i've officially forked nail(1) aka Heirloom mailx(1) as S-nail(1)
on 2012-09-18 i have been able to work five weeks almost fulltime on
S-nail(1) development.  The first three weeks can be characterized as
hectic fireworks here and there, but then it got better and i was able
to work more or less topic-centric.  In the meanwhile S-nail(1) is more
than 230 commits away from the Heirloom base--and drifting further apart.

S-nail(1) v13 is the first release of S-nail(1), but it was forked from
Heirloom mailx(1) 12.5 7/5/10 that arose from Berkeley Mail 8. unless
i'm mistaken.  What characterizes S-nail(1) v13?

- The build system has been reworked almost completely.
  It is possible to fine-tune which features should be present in the
  binary and which don't.  The name of the binary can be chosen, and
  that choice is reflected all through the manual and the template
  resource file.  The manual is always complete and thus may document
  features that are not supported by the actual binary, though.
  Please see INSTALL for more.

- Compiler warnings can now be used.  Please see the example WARN= flags
  in the Makefile, but '-Wall -Wextra -pedantic' should be silent though
  certainly insufficient to reflect the complex work of modern compilers.

- The following recipient address list combines some of the major
  improvements that have been made:

    <addr1@cdröm.de>  (bier) , ./file1,
    Steffen Smöregäs (Humbabä) <sauer@bäüer.de> (Hummpäa)    ,
         sabberlot@träbbel.de  ,  (bier2) <a2@bür2.de> ,
       a3@b3.de (bier3)  , <a4@b4.de> (bier4, und \"bier5\")  ,
    |cat > pipe1 ,   (bier 6) <a6@bür6.de>  ,   ./file2        ,
    (co\$mm1) abc1@düf.de (cö,bmm,2)   (co\"m\"m.3) ,
    co\$bmm1 \"c,ömm2\" co\"m\"m.3 <abc2@däf2.de>  ,  |cat > pipe2 ,
    moppel@höppel.org

  That, on a single line, may be given to ":m" or (quoted) on the
  command line, or to "~c" or whatever, and it will work as expected
  (well, everything else would be a bug..) and result in the following
  sendmail(1) invocation:

  SENDMAIL.SH
  <-i a2@xn--br2-hoa.de a3@b3.de a4@b4.de a6@xn--br6-hoa.de abc1@xn--df-xka.de abc2@xn--df2-qla.de addr1@xn--cdrm-7qa.de moppel@xn--hppel-jua.org sabberlot@xn--trbbel-cua.de sauer@xn--ber-qla4j.de>
  >>>>>>>>>>>>>>>>>
  Date: Thu, 25 Oct 2012 17:12:15 +0200
  To:
  Cc: Steffen =?utf-8?Q?Sm=C3=B6reg=C3=A4s?=
    =?utf-8?Q?_(Humbab=C3=A4)?= <sauer@xn--ber-qla4j.de> (=?utf-8?Q?Hummp=C3=A4a?=),
    sabberlot@xn--trbbel-cua.de, moppel@xn--hppel-jua.org,
    <addr1@xn--cdrm-7qa.de> (bier),
    co$bmm1 =?utf-8?Q?"c,=C3=B6mm2"?= co"m"m.3 <abc2@xn--df2-qla.de>,
    (co$mm1) abc1@xn--df-xka.de (=?utf-8?Q?c=C3=B6,bmm,2?=) (co"m"m.3),
    (bier 6) <a6@xn--br6-hoa.de>, <a4@b4.de> (bier4, und "bier5"),
    a3@b3.de (bier3), (bier2) <a2@xn--br2-hoa.de>
  Subject: Re: SubjectTest
  MIME-Version: 1.0
  Content-Type: text/plain; charset=us-ascii
  Content-Transfer-Encoding: 7bit

  body
  <<<<<<<<<<<<<<<<<

  So list parsing has been fixed, IDNA support has been added, and it is
  possible to mix pipe and file recipients *and* multiple thereof, and
  the result is still correct for *all* of them.
  I think this kind of list can be given wherever a user can directly
  enter such a list.  And i think all that is unique to S-nail(1).

- When writing back edited messages the target MBOX mailbox can no
  longer become "corrupted" when the trailing newline was removed during
  the edit.  Also affected FreeBSD and NetBSD mail(1).

- A security fix for CVE-2011-2895 was applied.

- The generated Message-Id: is now more human-friendly.

- The -h command line option has been dropped.  Use "-O -h XY" if your
  MTA really supports that.

- The -O and -r command line options no longer enforce a one-shot send
  mode, and instead persist for the duration of the entire session.

- Variables set via the -S command line option are now (un)set twice;
  immediately and after all the resource files have been loaded.

- Other new or changed options/commands, in order of appearance:
  recipients-in-cc, smime-sign-include-certs, quote-fold, stealthmua,
  add-file-recipients, write, rfc822-no-body-from_, rfc822-show-all,
  mail/Mail, idna-disable, idna-strict-checks, ??

- In the codebase itself an effort to reduce duplicate work and
  introduce caching, and to minimize the use of local variables, was
  started, but that is long term.  A lot of improvements here and there,
  too, like using the well MD5 optimization from Wei Dai, Chris Torek's
  hash algorithm for hash tables etc.

- Incredibly important: an heraldic animal was found: snailmail.jpg!

The full history can be inspected by issuing the git(1) command

  $ git log --reverse s-nail..s-nailv13

A new TODO has been introduced, and it is getting longer and longer.
Thanks.
