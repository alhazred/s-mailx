S - n a i l / S - m a i l x  N e w s
====================================

  mdocmx(7) anchors are denoted by a number-sign #: typing
  "^A ANCHOR" while reading the man(1)ual in a capable less(1)
  will scroll to the manual's Point-Of-Interest, and pointing
  a web- browser to the "#ANCHOR" of the online manual works.

v14.9.9 ("Marsh tit savours first spring sun, II") 2018-03-06
-------------------------------------------------------------

A bugfix release.
I hope with this the fallout of the Christmas 2016 "address the
Dr. Problem workshop" has been fully resolved and thus MIME for
header address fields, even if iconv(3) is involved, been fully
restored!  We have even more tests for this now.

The release v14.9.8 was broken on big endian machines.
I will remove the v14.9.8 balls from the server by the weekend.
Sorry for the inconvenience!

Credits, in order of commit appearance: Slavko, Matej Mužila,
Rich Felker, Simon McVittie, Paride Legovini, Cág,
Predrag Punosevac.

We welcome Slavko, Matej Mužila, Rich Felker and Simon McVittie in
THANKS.

NOTES, ChangeLog (packager-affine)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

- The v14.9.* series called *pipe-TYPE/SUBTYPE*#461 handlers in
  display or quote mode with CR (carriage-return) bytes stripped
  because of a missing output file comparison check, which broke
  binary formats etc.  (Slavko)

- We now have native support for Libidn2.  (Matej Mužila)

- uname(1) is now hookable by setting the shell variable uname
  when calling make ("uname=MY-UNAME make config" etc.).
  (Simon McVittie)

  We no longer bake the kernel version into the binary, and
  `version'#287 includes uname(2) output.
  (Simon McVittie, Paride Legovini)

- We now support a fallback P(seudo)R(andomNumber)G(enerator)
  initialization even if getrandom(2)/getrandom(3) has been found
  by the configuration, just like we do for "/dev/urandom" usage.
  This does not affect systems with arc4random(3) or OpenSSL
  random usage.  (David Čepelík, Simon McVittie)

  A new OPT_SSL_RANDOM make.rc variable, by default initialized to
  the value of OPT_SSL.

ChangeLog
^^^^^^^^^

- `~@'#303 list-edit behaviour in -##? batch mode was broken.

- Character set names will now undergo generic normalization,
  including stripping of iconv(3) //SUFFIXes.

git(1) shortlog (edited)
^^^^^^^^^^^^^^^^^^^^^^^^

Steffen Nurpmeso (33):
e9fdc08a a_amv_var_check_vips(): fix comparison (Slavko)
dd6e4084 THANKS: Slavko
caa5de77 make-config.sh: tweak new iconv(3) replacement warning (Slavko)
9e1c55f6 Fix ~@ list-edit behaviour in -# batch mode; add ~@ test
69225c69 Fix: do not strip CRs when "displaying" through a *pipe-** handler
        (Slavko)
940d84f2 Add support for Libidn2 (Matej Mužila)..
38f33e37 THANKS: Matej Mužila
1d67806c Our iconv wrapper was completely broken!  Now fixed (Rich Felker)..
a27d23ef cc-test.sh: fix t_behave_iconv_mbyte_base64 (Rich Felker)..
70a18a40 THANKS: Rich Felker
a46c4a0a Do not bake kernel version into binary (Simon McVittie, Paride
        Legovini)..
7f848761 THANKS: Simon McVittie
19673cbd Make uname(1) hookable (Simon McVittie)
1a488de9 Add OPT_SSL_RANDOM+, "fix" getrandom(2) (David Čepelík, Simon
        McVittie)..
8a9237c5 Fix n_boolify() with empty argument
ac67d755 FIX: again fallout of [0ede309c], not covered by [ffd29558] (Cág)..
dd6adbb3 IMAP does not need ICONV if ALWAYS_UNICODE_LOCALE (Predrag Punosevac)
c86a5ec6 `version': support vput and include uname(2) output (Simon McVittie)
1b018a36 Add *headline-plain* to force ASCII graphics (Cág)
...
565219b9 cc-test.sh: ARGH! MBOX content statistics not portable!
        (Gaetan Bisson)
e1e62dd1 Fix n_iconv_str() [on big endian machines, the author]

v14.9.7 ("Marsh tit patiently scraping bark") 2018-02-16
--------------------------------------------------------

A maintenance release which fixes bugs and brings in features.

Credits, in order of commit appearance: Alexander Harm,
Viktor SZÉPE, Paul Eggert, Joseph Bisch, Paride Legovini,
and Peter J. Holzer.
A special credit to the disappearing mutt(1) bug tracker.
And to Gmane.org for creating gmane.mail.s-mailx.general!

Thanks Paride Legovini for becoming maintainer of the Debian port.

We welcome Joseph Bisch, Paride Legovini, and Peter J. Holzer in
THANKS.

NOTES, ChangeLog (packager-affine)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

- The USB stick loss reported for v14.9.6 was fake news, so to
  say, the stick exists and therefore the old key is not
  compromised.

- We are back at Gmane.org!
    news.gmane.org/gmane.mail.s-mailx.general

- `history'#198 has learned to be context-sensitive a bit, and
  has two new subcommands, `load' and `save'.

    This is in parts backward incompatible because it needs a new
    *history-file*#406 format; however, the old format can be loaded
    yet compose-mode commands will not appear in compose mode no
    more.  Iirc you can start with an old format then `save' to
    the new, then replace the "d" in the first column with "c" for
    compose-mode commands which should appear correctly.

- Obsoletion warnings for variables now happen at `set'#254
  time instead of when used.  Running once via -v#81 may
  be beneficial.

- The saturation modifier of `vexpr'#288 is henceforth a prefix,
  the suffix version is obsolete (but still supported for a while).

- A network address that contains no domain-, but only a valid local
  user <name> in angle brackets will be automatically expanded to
  a valid address when *hostname*#411 is set to a non-empty value;
  setting it to the empty value instructs us that the used *mta*#440
  (including builtin SMTP) will perform the necessary expansion.
  (Viktor SZÉPE)

  Note that *hostname*#411 as well as *smtp-hostname*#521
  will now undergo IDNA expansion if IDNA is supported.

  And *from*#400 and *sender*#498 are now verified at `set'#254
  time, not when used.  (Viktor SZÉPE)

- The commit message in [d503bd82] is wrong, apologies to
  Paride Legovini.  The test(1) operator "-n" appeared in Seventh
  Edition UNIX, not V8 as falsely claimed.

ChangeLog
^^^^^^^^^

- Our `addrcodec'#130 parser chokes on lesser constructs.

- Presence of command-line MTA arguments without *expandargv*#390
  are now a hard error.  It was my fault that this was not the
  default from the very start.  (Viktor SZÉPE)

- Seen on the mutt bug tracker, we also still have had problems
  with time settings that cross 32-bit boundaries.  As that is
  in parts induced by the C standard, now implement those parts on
  our own, and be super careful in general.  (Joseph Bisch)

- The `~@'#303 command escape did not shell-unquote the user input
  again and was thus a bit broken; message attachments also work
  again.

- Support custom headers from the command line via -C#58.
  And *customhdr*#377 is verified upon `set'#254 time.

- The simple builtin HTML viewer now supports <blockquote>
  elements, which many web mailers, most notably gmail, use for
  citation.  (Peter J. Holzer)

git(1) shortlog (edited)
^^^^^^^^^^^^^^^^^^^^^^^^

Paride Legovini (1):
d503bd82 Patch configure script to not override build variables..

Steffen Nurpmeso (66):
437a103d mail1(): tweak "failed encoding" error message (Alexander Harm)
5f951f7b n_utf8_to_utf32(): FIX: implement compliant to Unicode 9.0, 3.9,
        UTF-8
6ac954a4 mime_fromhdr(): normalize \0 and \n in encoded-words (mailspoof)
c59a20ff myaddrs(): Fix: do not return invalid *from* (Viktor SZÉPE)..
efc59473 *expandargv*: hard error if unset (Viktor SZÉPE)..
ef94b2d6 README: we are back at Gmane.org!
a832ef40 Yay!  We have submissions:// at port 465 (too)! (RFC 8314)
cac4decc config.h: resort; fallback for S_ISDIR() (Paul Eggert)
1e43647b unixtime(): check mktime(3)+localtime(3) returns (Joseph Bisch)..
068fe5d3 fakedate(): implement ourselfs (Joseph Bisch)..
f430e3cc THANKS: Joseph Bisch
94ec5975 nail.1: fix spelling errors (Paride Legovini)
3311b6b9 THANKS: Paride Legovini
74d64ec7 cmd-headers.c,cmd-tab.h: fix spelling errors (Paride Legovini)
8477ea6f nail.1: yet another fix (Paride Legovini)
efe354ea More ISO C time and date checks etc. (Joseph Bisch)
f5409738 a_attachment_is_msg(): fix #NO message attachments (since
        2017-01-22)!
65ff0741 a_amv_var_check_num(): fix: variables need 32-bit not 64-bit limit!
fd2daba5 n_attachment_list_edit(): FIX: unquote user input again (!!!)
75917c30 ([BWDIC]) `history': support context-sensitive history (a bit)..
ff8b2ba1 Add -C (create custom header), change *customhdr*
2e67ac32 `vexpr': obsolete @ as suffix, it must henceforth be prefix..
b882c9b9 `vexpr': numeric ops: support [UuSs] number prefixes
2f356cd2 `vexpr': add `pbase' subcommand
9e652437 HTML filter: support <blockquote> quotes (Peter J. Holzer)
90e708e7 THANKS: Peter J. Holzer
9c7ea9cb Try to avoid tracing and attaching to privsep program
a4e21888 -S: as if within $'' if *v15-compat* (Alexander Harm)
333ecee1 *from*, *sender*: verify upon `set' time (Viktor SZÉPE)
ccaa7401 Optionally append *hostname* in "valid <user>" address (Viktor SZÉPE)

v14.9.6 ("Marsh tit abiding a snow storm"), 2017-12-05
------------------------------------------------------

A bugfix release which fixes four serious and three other bugs.
A few new features came in, too.

Many thanks go to Ralph Corderoy who reported an issue that was
caused by a terrible, terrible word reversal that i managed to
produce in December 2016, and which caused the v14.9.x series to
not MIME encode (non-address) content of address header fields!

Credits, in order of commit appearance: Thomas Dickey,
Andreas Baumann, Erich Eckner, Gaetan Bisson, Solar Designer, Cág,
Ivan Tham, Ralph Corderoy and Doug McIlroy.

We welcome Andreas Baumann, Erich Eckner, Solar Designer and Cág
in THANKS.

NOTES, ChangeLog (packager-affine)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

- After USB stick loss the authors OpenPGP key has been switched to

    pub   4096R/1883A0DD 2017-11-30 [expires: 2027-11-28]
          Key fingerprint =
            EE19 E1C1 F2F7 054F 8D39  54D8 3089 64B5 1883 A0DD
    uid                  Steffen Nurpmeso <steffen@sdaoden.eu>

- $TMPDIR#593 no longer honoured for root runs.  (Solar Designer)

- *mime-encoding*#438 defaults to quoted-printable again.  (Cág)

- We _can_ MIME encode even header fields which contain addresses.
  Thanks to Ralph Corderoy we now also _do_ so again!

ChangeLog
^^^^^^^^^

- ***#336 now uses *ifs*#413 when splitting.

- Freezing *ttycharset*#559 via -S#76 also survives using or
  setting any of $LC_ALL#575, $LC_CTYPE#576 and $LANG#577 during
  program startup.

- New `local'#114 command modifier to localize changes.
  Yet supported only for `set'#254, i.e., we have gained
  macro-local variables.

- `vexpr'#288 now supports a BASE#number notation for integers,
  like 16#AFFE as an alternative to 0xAFFE.

  Hint: variable settings can most often use several bases, too,
  e.g., i have "set mime-counter-evidence=0b1111".

- Very simple form of *quote-chars*#481 to adjust our knowledge of
  what actually is to be treated as a quote character.

- *mime-counter-evidence*#437 deep inspection (bit four) has
  been improved for the sole cases of quoting or displaying
  a message.  So messages with less than 25% of control characters
  and such will now be displayed (made printable).  This is yet
  not configurable nor do we have a way to easily access a message
  with more than that.  (Doug McIlroy)

git(1) shortlog (edited)
^^^^^^^^^^^^^^^^^^^^^^^^

Steffen Nurpmeso (44):
9bdfeba2 Introduce *mta-no-receiver-arguments* to bypass OpenSMTPD behaviour..
4ce4f80d mail1(): fix: unroll compose-mode `localopts' even on compose
        failure!
3dc1d4ee FIX debug assertion (Thomas Dickey)..
b039b309 a_main_startup(): isatty() yay fdopen(,"w") nay (A. B., E. E., G.
        B.)..
e6ec2b06 THANKS: Andreas Baumann
5e808dc1 THANKS: Erich Eckner
7cc7fd0a Invent n_O_NOXY_BITS for more O_NO* etc. (Solar Designer)
409c5df7 THANKS: Solar Designer
62d5947a config.h: no, change [f64eb665], use MIMEE_QP again (Cág)
43449982 THANKS: Cág
cd212599 Do not honour $TMPDIR if run by root (Solar Designer)
3e283d18 Fix semantics of $* to go for *ifs*
6d437ab6 FIX i_strdup(), broken since [354fc47e] as of 2017-07-16..
c20b6b7c nail.1: WHEN is a mlist a regex (Ivan Tham)
bd72268c nail.1: FAQ: Can S-nail git-send-email? (Cág)
ffd29558 FIX [0ede309c] as of 2016-12-26! (Ralph Corderoy)..
fce7d5ca FIX: LC_ALL/LC_CTYPE/LANG: do not _force_ overwrite of *ttycharset*..
16fb7bf7 `environ' unset: report errors (remove respective TODO)..
8eb67f95 Add `local' command modifier: alter command to work on block-scope
23327af7 n_idec*(), `vexpr': support BASE#number (2 <= x <= 36) notation
78727768 "[@fields]@" spec.: support regex in fields, empty body: header
        exists
ca35643c Add *quote-chars* (simple)
429a294d Improve *mime-counter-evidence* deep inspection (Doug McIlroy)..
c0fcb67c Introduce *version-hexnum*
090819a2 Fix [ab0cd3b8]..
8c72989b cc-test.sh: fix test of [ffd29558]..

v14.9.5 ("Marsh tit engaged with a peanut"), 2017-10-21
-------------------------------------------------------

A bugfix release which fixes two bugs which were cast in stone.
A few compatibility improvements (AlpineLinux, Solaris).
And minor features.

Apologies to Jörg Schilling, a git bug i think it was who caused
joining of changesets, loosing a credit, and it had been pushed to
[master] before the problem was realized.

Credits, in order of commit appearance: Jörg Schilling,
Doug McIlroy, Random832, Nick Stoughton and Ivan Tham.

We welcome Nick Stoughton and Ivan Tham in THANKS.

NOTES, ChangeLog (packager-affine)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

- New OPT_USE_PKGSYS option can be disabled to not automatically
  pick known package system paths (pkg(7), OpenCSW, schily).
  (Jörg Schilling)

ChangeLog
^^^^^^^^^

- The software indeed _never_ dealt with iconv(3) output character
  set errors (as opposed to invalid input character set byte
  sequences etc.) for the main message body!
  And I have missed that when i tweaked our iconv layer a bit!

- Fixed a race condition with sigsuspend(2) that i could only see
  on OpenBSD.  config.h offers n_SIGSUSPEND_NOT_WAITPID, by the
  way, which saves some systemcalls and did not run races, but
  noone adjusts this file.

- Message list specifications gained two new colon modifiers, one
  can now "search :Ll" to find "Mailing lists"#10.
  The *headline*#403 format %T now also uses L and l rather than
  S and L accordingly.

  New `addrcodec'#130 subcommand `skinlist' acts like `skin'
  but stores in *!*#332 *^ERR*#334-EXIST if the address is
  one of the known "Mailing lists"#10.

- `echo'#167 family now supports `vput'#117 and *!*#332 error
  storage, offering some kind of printf(1) experience, almost.

git(1) shortlog (edited)
^^^^^^^^^^^^^^^^^^^^^^^^

Steffen Nurpmeso (35):
d76fd200 Fully support putenv(3) fallback (Jörg Schilling)
ab0cd3b8 FIX iconv for main body part (since EVER!) (Doug McIlroy,
        Random832)..
8d472b37 FIX sigsuspend(2) race condition (since EVER! Only seen on OpenBSD)..
ca045d7d Add is_mlist_mp() and :Ll colon modifiers, and use "Ll" for
        *headline*'s %T
88a69abf Set termsize after SIGCONT; n_signal(): use sigfillset (Nick
        Stoughton)..
f169483d THANKS: Nick Stoughton
2f1e46ee `echo' family: support `vput' and *!* error storage
22ac50c7 make.rc, make-config.sh: add OPT_USE_PKGSYS (Jörg Schilling)
09a8b2ef Even less shell globbing (Ivan Tham)
b35ccc6d THANKS: Ivan Tham
820d02b4 obs-imap.c: drop dopr(), pr(1) often not available
2a05fcd9 main.c, make-config.sh: preparate for tcgetwinsize(3)
9feaf8ae `addrcodec': add skinlist subcommand, skin+check whether mlist

v14.9.4 ("(5th anniversary) Marsh tit"), 2017-09-18
---------------------------------------------------

This is an update feature release but which also ships a furious
number of bug fixes, about six of which were pretty serious.  It
also applies overall trimming, and improves configuration time
compatibility on macOS.

Thanks to Alexander Harm there is now a macOS Homebrew package.

Credits, in order of commit appearance: Paul Vojta, Daniel Lublin,
Alexander Harm, Norman Ramsey, Viktor Szépe, Rich Salz,
David Čepelík, Ralph Corderoy, Stéphane Chazelas, Aharon Robbins,
Ken Hornstein.

We welcome Daniel Lublin, Alexander Harm, David Čepelík and
Stéphane Chazelas in THANKS.

NOTES, ChangeLog (packager-affine)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

- Out-of-tree builds have become possible via the new
  make-emerge.sh script:

  $ cd /tmp && mkdir build && cd build &&
    ~/src/nail.git/make-emerge.sh &&
    make tangerine DESTDIR=.ddir

  We now have a `citron' make target which is like `tangerine' but
  does not run the tests.

- Configuration with OPT_AUTOCC honours $CC=cc. (Norman Ramsey)

- SSL/TLS configuration has been revamped (again) in order to
  support new possibilities of OpenSSL (and LibreSSL) without
  ending up and introducing more and more variables.

  Instead we now have *ssl-config-pairs*#542, a comma-separated
  list of all options.  With e.g. OpenSSL 1.1.xx this will be
  directly passed through to SSL_CONF_cmd(), so there _anything_
  can be passed, otherwise we use a builtin parser to map.
  The new *ssl-features*#546 states what is supported.  E.g.:

    if [ "$ssl-features" =% +ctx-set-maxmin-proto ]
      wysh set ssl-config-pairs='\
          CipherList=TLSv1.2:!aNULL:!eNULL:@STRENGTH,\
          Curves=P-521:P-384:P-256,\
          MinProtocol=TLSv1.1'
    else
      wysh set ssl-config-pairs='\
          CipherList=TLSv1.2:!aNULL:!eNULL:@STRENGTH,\
          Curves=P-521:P-384:P-256,\
          Protocol=-ALL\,+TLSv1.1 \, +TLSv1.2'
    endif

  OpenSSL v1.1.xx also introduces an interesting and neat idea to
  centralize SSL/TLS configuration of (all) programs in a single
  file.  This can be driven via *ssl-config-file*#540 and the new
  *ssl-config-module*#541 variables, several entries per program
  are allowed, see *ssl-config-module*#541 for an example.

  New manual section "Encrypted network communication"#13.

- Variables set or unset via -S#76 are now frozen until program
  startup is complete.

ChangeLog
^^^^^^^^^

- Historical behaviour of *askcc*#348 / *askbcc*#349 has been
  reintroduced.  (Norman Ramsey)

  A new *asksend*#350 variable will show a final header summary
  and allows reentering compose mode.  Set by default.

  POSIX mirrors *ask* onto *asksub*#352, so dropped" the former.

- `~^'#305 no longer normalizes header names to titlecase.

- We no longer generate charset=binary MIME parameters.
  This was introduced on 2013-01-02 and was i think owed to
  file(1)s -i output as i failed to find any other reference.
  (Normal Ramsey)

- *mime-alternative-favour-rich*#436 now also works for handlers
  installed via *pipe-TYPE/SUBTYPE*#461. (Viktor Szépe)

- v14.9.* series did not generate In-Reply-To: headers!

- `alias'#131 now supports high-bit bytes and semicolon.
  Expect that at some later time the input must be valid according
  to the locale, though. (Norman Ramsey)

- Combinations of *record*#485 could crash because of an
  unterminated variable function argument list. (Norman Ramsey)

- New command `readall'#234 loads an entire file into a variable.

  *signature*#505 has been obsoleted.

- `vexpr'#288 now supports negative arguments for the substring
  subcommand and adds trim, trim-front and trim-end subcommands.

- `!'#121 can be used in send mode.

- `~A'#306, `~a'#307, `~I'#316 and `~i'#317 will henceforth expand
  \t and \n only if *posix*#474 is set.
  Please use `set'#254 instead (with `wysh'#118, until v15).

- New "The mime.types files"#35 type marker: @q ("quiet").

git(1) shortlog (edited)
^^^^^^^^^^^^^^^^^^^^^^^^

Steffen (Daode) Nurpmeso (90):
9becdd01 Fix [32e5c7c2] (MLE: KHT: auto-append / for directories at once..)
cc54681e $PAGER: always set (non-existent) $LESS=RXi (Paul Vojta)..
49124f13 nail.1: use `~.' in "On sending mail.." (Daniel Lublin)
7cd29917 THANKS: Daniel Lublin
62f5957f nail.h: unconditionally include inttypes.h (Alexander Harm)..
c121f519 THANKS: Alexander Harm
f0aeef8d Adjust OpenCSW & pkgsrc paths, drop CONFIG=MEDIUM (Alexander Harm)..
19fdc151 INSTALL: tweak INCS and LIBS (Alexander Harm)
24199743 make-config.sh: integrate DYLD_LIBRARY_PATH in LD_.. (Alexander Harm)
64026f7b make-config.in: also needs .PHONY for MacOS (Alexander Harm)
52ddd687 make-config.sh: OPT_{NOMEMDBG,ASAN_*}: reduce cc_maxopt=1 (Alexander
        Harm)..
f3087a5c Fix **-honour* <-> *recipients-in-cc* for original To: ones
2205dc27 Fix: ask for `write' targets of message/rfc822 attachments (again)
5cd0f50d Restore historical behaviour of *askb?cc* (Norman Ramsey)
80038311 Fix: do not generate charset=binary parameter (Norman Ramsey)..
05427cea send.c:sendpart(): extend *mime-alternative-favour-rich* support
        (SZÉPE Viktor)..
226c1f26 FIX In-Reply-To: generation, broken since [c13e1205], 2017-06-04!
135cbebe makefile: add missing reverse solidus (Norman Ramsey)
8a4237d2 `alias': support high-bit bytes and semicolon (Norman Ramsey)
22c48009 a_nag_group_lookup(): FIX used case-i?sensitive hash function!
1bc65e1b a_amv_var_lookup(): error log on empty environment variable (Norman
        Ramsey)
179b39f3 sendout.c:mightrecord(): FIX: terminate starg list! (Norman Ramsey)
c2635714 Add `readall' command
999a9dbf `vexpr': substring: support negative offset / length
58474b55 `vexpr': add trim, trim-front and trim-end subcommands
7ab345ae Allow `!' in send mode?!
08305026 Obsolete *signature* (quite some better and more generic ways now!)
cd03ec01 Glue ~A,~a,~I,~i \t and \n expansion to *posix*; while here: resort
c5a223d8 Introduce @q MIME type marker
93a4e38a Rework (usage of) *SSL random handling (Rich Salz)..
f2cc9b83 Work around possible Linux getrandom() bugs (David Čepelík)
35879445 THANKS: David Čepelík
dddff6ef Extend the meanings of *fullnames*..
884983a3 Diversify n_PSO_STARTED_ states, gain more cmds via -X
ba103b71 Reserve command modifier prefixes "local" and "u"
4ff9c046 {make-{config,emerge},cc-test}.sh: no command -v (Norman, Ralph,
        Stéphane)..
2a2895f1 THANKS: Stéphane Chazelas
24615d82 make-config.sh: accept CC=cc (Norman Ramsey)
d6f18b52 Add more support surrounding OpenSSL config stuff++..
94bafbc6 Temporarily freeze variables set via -S..
bb0d0bf2 Port to SunOS 5.9 (Aharon Robbins)
788faabe Support *pipe-message/external-body* access-type=url handlers (Ken
        Hornstein)
02407c15 FIX maildir "yet-exists" hashmap!..

v14.9.3 ("Crested tit nibbling sunflower seeds"), 2017-08-03
------------------------------------------------------------

This is a bugfix release but which ships some improvements, too.
It silently replaces both of v14.9.1 v14.9.2 from earlier this
week, which were broken or not entirely fixed.

Credits, in order of commit appearance: Felix Fontein, Paul Vojta,
Ralph Corderoy, Christos Zoulas, Gavin Troy, Gaetan Bisson.
Thanks, Coverity.com.

We welcome Christos Zoulas in THANKS.

Apologies to Viktor Szépe for the false spelling of his name in
the v14.9.0 announcement.
And to Gaetan Bisson for not giving credit for [14fbce97]!

NOTES, ChangeLog (packager-affine)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

- fakeroot support was blindly taken from Debian and broken.
  (Gavin Troy, Gaetan Bisson)

- Base64 output was broken for cases which involved iconv(3).
  The data is not lost, you can read it with S-nail v14.9.0 and
  above, and save it somewhere.  I know of no other base64 decoder
  which reads those things correctly, though.  We now have tests.
  Along this i fixed an iconv(3) error which likely caused
  stateful decoding (like, e.g., for ISO-2022-JP) to fail because
  of an unnecessary reset of the iconv(3) state machine.
  Thanks to Gaetan Bisson for mentioning this issue!

ChangeLog
^^^^^^^^^

- In compose mode the MLE allows empty lines again.

- We no longer require a writable $HOME#574.  Due to false code
  flow (but but but: with correct comment) a non-writable $HOME
  entry in /etc/password (i.e., from getpwuid(3)) would lead to
  a crash.  (Felix Fontain; Ralph Corderoy)

- Two faulty string operations slipped into the IMAP code,
  resulting in a crash and a "is-same-host" test that would fail
  for IMAPS connections like `save'#251 or `copy'#153 because of an
  implicit IMAP protocol for the target of those operations (thus
  IMAP != IMAPS).  (Paul Vojta)

- The MLE tab-expansion will now automatically append a "/" if
  there is only one possible expansion and that is a directory,
  saving the user one <TAB>.  (Christos Zoulas)

  The shell expression parser had a bug regarding understood
  metacharacters (;|&), which in turn could cause an infinite loop
  in the MLE tab-expansion for, e.g., "move &9 +<TAB>", because
  the "&" would never have been stepped over.

- New `~I'#316 command escape is like `~i'#317 but does not append
  a newline.

- `localopts'#203 gained an optional second argument.
  It is now possible to specify that any macro `call'#139ed
  will have localopts enabled, and it is possible to fixate the
  setting so that it cannot be reverted.

- *@*#338 should now act completely compatible to the sh(1)ell,
  thus obsoleting my hysteric warnings in the v14.9.0 announcement.

- The `Lreply'#204, `reply'#239, `Reply'#238 series as well as
  `mail'#206 now manage the error status *!*#332.
  I.e., there are now errors like *^ERR*#334-DESTADDRREQ,
  ^ERR-NODATA, ^ERR-PERM and similar.  It is not perfect yet,
  because $DEAD#572 may have been written (with *save*#493) or not,
  for example.

  `Lreply' and `reply' have been rewritten rather completely
  indeed.  They join Reply-To: and Mail-Followup-To: dependent on
  the context (i.e., *reply-to-honour*#491, *followup-to-honour*#397,
  see "Mailing lists"#10 for the picture), and if they did, use
  this list as the receivers exclusively.  It now honours
  *recipients-in-cc*#484 even for such addressees.  (And now i wonder
  whether i should have credited Paul Vojta for that.)

  Also `Lreply' would have crashed for mails with Reply-To: but
  without *reply-to-honour*#491 set.  We now have a test.

  Note *replyto* is obsoleted in favour of *reply-to*#490.

git(1) shortlog (edited)
^^^^^^^^^^^^^^^^^^^^^^^^

670aabb6 a_amv_var_check_vips(): FIX code to match comment (Felix Fontein)..
3dcdaa83 THANKS: Felix Fontein
3745e002 FIX [81d7f4d8] (IMAP: try (hard) to reinstantiate..) (Paul Vojta)
33b2834f FIX [81d7f4d8] (IMAP: try (hard) to reinstantiate..) (Paul Vojta)..
1cc0d3de Allow non-writable $HOME (Felix Fontain, Ralph Corderoy)
32e5c7c2 MLE: KHT: auto-append / for directories at once (Christos Zoulas)
e2bb54b7 THANKS: Christos Zoulas
f593fc18 make-config.sh: do NOT skip fakeroot paths
        (Gavin Troy, Gaetan Bisson)
4fe971ea FIX [4047a432] possible bound excess in memset()!
84efbcab FIX shexp parser regarding metachars (and poss. endless <TAB> loop)
14fbce97 FIX: OH!  The codebase NEVER supported *mime-encoding*=base64!

v14.9.0 ("Long-tailed tit"), 2017-07-16
---------------------------------------

This is a major feature release which took about ~22 months (24
less two) of development to complete, and which imposed massive
changes under the hood, but also quite a lot of user visible
changes, including some **backward incompatibilities**.
As usual, "s-nail -d" will show obsoletion warnings.

We gain noticeable improvements regarding scriptability and its
reliability, but also for interactive use cases, especially
notable to users is our completely new M(ailx)L(ine)E(ditor) that
supports rather real tabulator expansion and program-mode-context-
sensitive key bindings.

We now support macros with arguments, which can be `shift'ed,
a `return' status can be used, and a `vexpr' multiplexer offers
some arithmetic and string operations.  `commandalias'es are
recursive, further command modifier prefixes, like `ignerr', give
a hand that we otherwise could not offer.  In compose-mode the new
`~^' command escape allows some message and attachment access, and
can be used, e.g., to implement things like custom headers, and
has been especially designed for scripted access via the new
*on-compose-splice* and *on-compose-splice-shell* hooks.

S-nail will move (more or less) backward-incompatibly to sh(1)ell
compatible argument quoting (documented in "COMMANDS"), and an
increasing number of commands do support this already: new ones
exclusively, some old ones have either been switched (like
`localopts'), others -- noticeably `set' -- can be switched to the
new syntax with a `wysh' command modifier prefix.  E.g.:

  ? define __xv {
    # Be careful to choose sh(1)ell-style on _entire_ line!
     localopts yes; wysh set verbose; ignerr eval "${@}"; return $?
    }
  ? commandalias call echo boo-boo
  ? commandalias xv call __xv
  ? xv list
  ? commandalias xv '\'call __xv
  ? xv list

Calling the latter `xv' for `list' will give more detailed command
information, including which kind of argument is used.

I have not managed to implement the three features i have started
this development cycle for, these are thus subject to further
development, just like wysh for message-list argument commands to
support, e.g., negation, wysh for `if' and consorts, the --
terminator to finally overcome the ridiculous requirement to quote
entire shell commands filenames for commands like `pipe.
And and and.

Credits, in order of commit appearance: Antonio Radici,
Aharon Robbins, Mike Frysinger, Predrag Punosevac, Michael Convey,
Hariskar, Rudolf Sykora, Martin Neitzel, Gavin Troy,
Salvatore Bonaccorso, Todd C. Miller, Sergey Matveev, Robert Elz,
Mantas Mikulėnas, Respiranto, Jens Schleusener, Walter Alejandro
Iglesias, Ralph Corderoy, David Levine, Lyndon Nerenberg,
Thomas Dickey, Afan, Justin Ellingwood, Ingo Schwarze,
Viktor Szépe, Gaetan Bisson, Juan RP, William Yodlowsky,
Hilko Bengen, Matthew Dillon, Colin Watson, Donald Mugnai,
Stephen Isard, Jürgen Daubert, Sven Neuhaus, trondd, Ismael Bouya,
Felipe Gasper, Paul Eggert, Dr. Werner Fink, Ken Hornstein,
Noel Chiappa, Random832, Doug McIlroy, Baptiste Daroussin,
Riccardo Ductor, Pietro Cerutti, Jörg Schilling, rain1, Xin LI.

We welcome Antonio Radici, Mike Frysinger, Predrag Punosevac,
Michael Convey, Rudolf Sykora, Todd C. Miller, Robert Elz,
Jens Schleusener, Walter Alejandro Iglesias, Thomas Dickey, Afan,
Justin Ellingwood, Viktor Szépe, Juan RP, Matthew Dillon,
Colin Watson, Donald Mugnai, Sven Neuhaus, Ismael Bouya,
Felipe Gasper, Paul Eggert, Dr. Werner Fink, Ken Hornstein,
Noel Chiappa, Random832, Doug McIlroy, Baptiste Daroussin,
Riccardo Ductor, Pietro Cerutti, Jörg Schilling, rain1, and
Xin LI in THANKS.

Apologies: Sergey Matveev.
Members of the Roff community which await progress.

NOTES, ChangeLog (packager-affine)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

* This release brings some backward incompatibilities, outlined
  in the following.  Most users will not be affected, and we have
  added a lot of compatibility cruft, but that will vanish in v15.
  "$ s-nail -v"!

* The configuration and build system has changed.
  Packagers have received updated package files.

  o Anything which was WANT_xy before is now OPT_xy, and
    compiled-in paths and values, like PREFIX or PAGER, have
    gained a VAL_ prefix (thus VAL_PREFIX and VAL_PAGER).

    This is _not_ true for non-persistent or environmental values,
    e.g., DESTDIR, CC, etc., and also not for the overwritable
    program variables during configuration, e.g., $awk.

  o SENDMAIL -> VAL_MTA, SENDMAIL_PROGNAME -> VAL_MTA_ARGV0,
    MAILSPOOL -> VAL_MAIL.
    And NAIL -> VAL_MAILX, though this is still a lie.

  o The make system now needs config..build..install or
    all..install or tangerine (config..build..test..install).
    Some constants which some experts may want to fine-tune have
    been moved to config.h.  Usual adjustments+doc via make.rc.

  o The `build' phase can be parallelized by setting the $MAKEJOBS
    environment variable, e.g., "make MAKEJOBS=-j4 build".
    Note this variable is not tracked in the configuration.
    (Gaetan Bisson)

  o Unless DESTDIR is set an uninstallation script will be
    installed along with the rest (see INSTALL file for more).

  o Set the new OPT_CROSS_BUILD to avoid feature runtime tests,
    only compile- and link-availability will be tested.  (Juan RP)

  o VERBOSE is implemented straight, but must be given at
    configuration time in order to become honoured.
    (William Yodlowsky)

  o ADDCFLAGS / ADDLDFLAGS -> EXTRA_CFLAGS / EXTRA_LDFLAGS.

  o The LD_LIBRARY_PATH etc. building processes will skip any path
    which contains the string "fakeroot".  (Hilko Bengen)

  o We honour a set $SOURCE_DATE_EPOCH#591 environment variable to
    an extend that allows reproducible tests, which is why the
    repository gained a [test-out] branch with some expected plain
    text outputs.  (reproducible-builds.org; Colin Watson)

    The new *log-prefix*#424 variable aids in improving the
    reproducibility of error messages.

  o These are upward compatible changes.

* "make OPENSSL_API_COMPAT=0x10100000 all" should work.

* Internal and environment variables are now explicitly _defined_
  and _tracked_ after variable handling has been rewritten
  completely.  Notes:

  o This means that, e.g., "$ password=NOT_SECRET s-nail" will
    **NOT** work no more, since *password*#459 is an internal
    variable!

  o But if you do, e.g., "? set TMPDIR=~/tmp", then this will
    also be reflected in the program environment (it is an
    environment variable) and thus affect child processes.

  o Therefore we no longer have `setenv' and `unsetenv'.

  o To integrate any other environment variable transparently
    into our variable management, the new command `environ'#175
    needs to be used, e.g., "? environ set NEWVAR=value" or
    "? environ link EXISTINGVAR".

- -H#65 and -L#68 have been decoupled:
   it used to be -e#62 -L#68 instead!

- *NAIL_{HEAD,TAIL}* have been obsoleted in favour of
  *message-inject-head*#432 and *message-inject-tail*#433.

  *NAIL_HIST{FILE,SIZE}* have been obsoleted in favour of
  *history-file*#406 and *history-size*#409.

  *NAIL_EXTRA_RC* has been obsoleted in favour of
  *mailx-extra-rc*#427.

  *batch-exit-on-error* has been obsoleted by *errexit*#387, which
  works just like the POSIX sh(1)ell "set -e" construct; the
  `ignerr'#113 command modifier (`-' for command escapes in compose
  mode, and see below) can be used to ignore command errors even
  then.  (This will remain even if we at some later time will
  support at least some of the sh(1) constructs which "swallow"
  failures with set -e.)

  *bsdannounce* is obsolete, the feature is integrated in
  *header*#402 as this is much more useful.  (This is however also
  dependent upon the also new but well-known $POSIXLY_CORRECT#589
  <> *posix*#474, but that is just how it is; these affect more
  behaviour, and increasing.)

- Colour support has been changed backward in- and upward (from
  user interface side) compatibly, see the manual section
  "Coloured display"#18.

  + New commands: `colour'#148 and `uncolour'#149.
    You can define context-sensitive, terminal-capability-
    sensitive settings, e.g.:

      if terminal && [ "$features" =% +colour ]
        colour iso  view-header ft=bold,fg=magenta,bg=cyan
        colour 256  view-header ft=bold,fg=208,bg=230 subject,from
        colour mono view-header ft=bold
        colour mono view-header ft=bold,ft=reverse subject,from
      endif

  + The variable *colour-pager*#373 defines whether colour and font
    attribute sequences should be generated when viewing something
    in $PAGER#587.

  + Set the variable *colour-disable*#372 to turn colour off
    without affecting established settings.

  + It is deduced via termcap(5) (see below) whether the terminal
    supports colors, e.g., "$ s-nail -Stermcap=Co#256".
    This is also true if we don't have termcap support.

  + Support for 256-colour terminals. (Gavin Troy)

- `source'#266 series support shell pipes if the last character
   of the "filename" ends with a vertical bar |, e.g.,

      ? source 'gpg -qd ~/.s-nailrc-private.gpg |'

- Shell pipes are also supported as targets for `move'#216,
  `copy'#153 etc., yet unfortunately not with via a sh(1)ell token
  parser, so that the target still has to be a single argument.

      ? copy . '| cat; echo huhu'

- Support for custom headers via the new `~^'#305 compose-mode
  command escape and in addition, or alternatively, with the
  internal variable *customhdr*#377, which also can be covered by
  `localopts'#203.  (Sergey Matveev)

  + Support of $ORGANIZATION has been dropped.

  + Command escape `~e'#311 supports _any_ header.

  + Command escape `~^'#305 supports _any_ header.

- New -:#53 command line option can be used to more easily select
  which startup files should be loaded, e.g., -:/ loads none.
  (Robert Elz)

- `account'#128s and *folder-hook*#394s now have `localopts'#203
   enabled by default.

- A first simple form of compose-mode hooks has been implemented:
  *on-compose-enter*#452, *on-compose-leave*#453 and
  *on-compose-cleanup*#451 can be set to macros which get invoked
  at appropriate times.
  For the `resend'#243 series there is *on-resend-enter*#457 and
  *on-resend-cleanup*#456: this is very likely to change once
  true message access is possible even in this mode.

  An even more powerful mechanism is available via the also new
  *on-compose-splice*#454 and *on-compose-splice-shell*#455 hooks.
  These are executed in child processes and communicate with the
  parent via their standard input and output, and therefore can
  do anything and act as if they were the user.

  `localopts'#203 are enabled and cannot be disabled (and extend
  until the message is sent).
  (Jens Schleusener, Rudolf Sykora)

    ? set on-compose-splice=ocs
    ? define ocs {
      read ver
      echo Splice protocol version is $ver
      echo '~^header list'
      read hl; vput vexpr es substring "${hl}" 0 1
      if [ "$es" != 2 ]
        echoerr 'Failed to read header list, bailing out'
        echo '~x'
      elif [ "$hl" @i!% ' cc' ]
        echo '~^header insert cc Diet is your <mirr.or>'
        read es; vput vexpr es substr "${es}" 0 1
        if [ "$es" != 2 ]
          echoerr 'Failed to insert Cc:, bailing out'; echo '~x'
        end
      end
    }

- "The .netrc file"#37

  + gained support for comments.
    (Walter Alejandro Iglesias, Ralph Corderoy)

  + `netrc'#219 now has a "load" subcommand.

  + the new *netrc-pipe*#446 obsoletes OPT_AGENT and
    *agent-shell-lookup*, and can be used to load an encrypted
    .netrc file, e.g.:

      ? set netrc-lookup netrc-pipe='gpg -qd ~/.netrc.gpg'

    I.e., this is in usual .netrc syntax and thus possibly much
    nicer than saying "? source 'gpg -qd ~/.credentials.gpg |'".

- termcap(5) / terminfo(5) support has been changed backward in-
  and upward (from user interface side) compatibly, please read
  "On terminal control and line editor"#17.

  + OPT_TERMCAP is by default enabled.
    The new, by default enabled, configuration option
    OPT_TERMCAP_VIA_TERMINFO can be used to (try to) use
    terminfo(5) instead.

  + The variable *termcap*#554 can be used to freely define or
    override terminal capabilities, and *termcap-disable*#556 will
    disable interaction with the chosen library, leaving only
    *termcap* in charge.

    To use the so-called ca-mode on supporting terminals,
    effectively turning S-nail into a fullscreen application,
    *termcap-ca-mode*#555 must be set.

  + The built-in line editor has been rather completely rewritten
    to be the Mailx-Line-Editor (OPT_MLE, default yes), and
    supports wide glyphs (if possible), infinite line lengths
    (2 GB) and more.  Tabulator expansion is no longer an option
    (but needs fnmatch(3)).

  + Optionally (OPT_KEY_BINDINGS, default yes) it has become
    possible to freely define key bindings for the MLE via the new
    `bind'#137 and `unbind'#138 commands.  These key bindings can
    make use of termcap(5) and/or terminfo(5) names.  The MLE will
    install a set of default bindings (unless there is a set
    *line-editor-no-defaults*#423), more so with OPT_TERMCAP,
    i.e., try "? bind*".

    Sufficient support provided, one can now, e.g., type "p " and
    then collect the message numbers to type, scrolling forward
    and backward via key-bindings, without loosing the line
    content, then commit the final line.

  + OPT_EDITLINE and OPT_READLINE support have been dropped.
    The new MLE should not miss anything.  Does it?
    Tip: in an UTF-8 locale try "? !touch /tmp/hall{,öchen}" and
    then autocomplete that: once, then ^Q, and again.

- `source'#266 can be used in `call'#139ed macros.
  What sounds so innocent replaced an entire machinery and got rid
  of a brilliant idea of Kurt Shoens from the 70s, but which never
  worked with Nail/Heirloom extensions, namely macros, and in the
  right order.
  Accompanying this -X#82 can (dig multiline arguments and can) be
  used to define macros and run them etc.  Should work:

    $ s-nail -X'define x {' -Xversion -Xx -X'}' -X'call x'
    $ s-nail -X'source \' -X'"echo version|"' -Xx

  Macros can be `undefine'#158d from within themselves, and re-
  `define'#157d.  It is still not possible to define macros
  from within macros, and/or have inner macros, not to talk
  about local scoping or anything more sophisticated such.

- -u#79 / $LOGNAME#580 ($USER) handling has been redefined,
  and "-u USER" is now exactly the same as "-f %USER", and
  $LOGNAME (and $USER) is actively set to the active user.  (Afan)

  $LOGNAME#580 is POSIX standardized and henceforth used and
  preferred over $USER, which came from BSD.  (Todd C. Miller)

- In the future (at least non-message-list) argument handling will
  be changed backward-incompatibly to be sh(1)ell compatible (and
  thus POSIX standardized), see "Shell-style argument quoting"#24.
  New commands use it already today (`bind'#137, `colour'#148,
  `headerpick'#194), some others (most importantly, `set'#254) can
  be forced to do so via the new `wysh'#118 command prefix, as in:

    ? wysh set message-inject-tail=$'\n--steffen'
    ? bind base $'\cA,\x61' 'echo control-A and small a'

- We now actively manage *umask*#561: 0077 by default, but an
  empty string will use the setting that is active upon startup.
  Just like changes to (known) environment variables, this setting
  will also be inherited by any child process.
  (Walter Alejandro Iglesias)

- Anything SENDMAIL / *sendmail*-ish has been renamed to *mta*#440,
  *mta-arguments*#441, *mta-no-default-arguments*#442 and
  *mta-argv0*#444.

  The reason is that in v15 we won't even have *smtp*: it is just
  another form of MTA, and thus obsolete by itself.
  Note that *mta-arguments* is now parsed via the shell-token
  parser, so the following ends up exactly as desired.

    ? set mta-arguments='-t -X "/tmp/my log"'

  For now we support a hack that understands a file:// URL in
  *mta*, too, but that is also the default if there is no protocol.
  E.g.: "? set mta=smtp://a:b@xy.z"

- The "spamd" *spam-interface*#524 is obsolete.  I haven't tested
  it since my main machine died, it is error prone since it assumes
  internals of the spamassassin wire protocol, and there never was
  a speed improvement over "spamc".  (However it could react upon
  the "is-spam" state of a message, which "spamc" doesn't allow.)

- The new *inbox*#417 variable will henceforth be looked up when
  searching for a primary system mailbox (as in "? File %"),
  followed by the usual $MAIL#581 and compile-time defined local
  mailspool search.  (Stephen Isard, Jürgen Daubert)

- The semantic of -a#55 and `~@'#303 have been changed, and both
  commands now use the same syntax:

    -a file[=input-charset[#output-charset]]

- New "failinvaddr" keyword for *expandaddr*#389.

- We finally "can" the so-called (by myself) "Dr. Problem" (a bit):
  (Dr. Werner Fink)

    $ </dev/null s-nail -d:/ -sTrödler 'Dr. D. Iet <z@a.k>' 2>&1 |\
      grep To:
    s-nail: >>> To: "Dr. D. Iet" <z@a.k>

  This can be done via the new `addrcodec'#130, too, note this
  supports multiple modes (and the `vput'#117 command modifier):

    $ echo 'addrcodec e Dr. Diet <to@fu.soj> Curd' | s-nail -#:/
    "Dr. Diet Curd" <to@fu.soj>

- All commands with the string "codec" in their name use different
  argument quoting, namely none at all, please read
  "Raw data arguments for codec commands"#25.
  This means that `urlcodec'#283 (and `imapcodec'#619) has
  slightly changed semantics.
  And, while here: there is a new `shcodec'#256, too.

- We gained "Command modifiers"#21: `\'#112 (avoid expansion of
  `commandalias'#150es), `vput'#117 (store result in variable),
  `ignerr'#113  (ignore an error of the following command, even
  if the new *errexit*#387 is set), `wysh'#118 (use shell-style
  arguments).

    $ echo 'vput cwd resvar;echo $resvar' | s-nail -#:/
    /home/steffen/src/nail.git

  And the usual sh(1) stuff: `return'#249, `shift'#260, `eval'#177,
  plus a `xcall'#292 stack-avoidance optimization (to be used in
  place of a `call'#139 which would be the last called command).
  And an "expr(1) like thing", yet simple, `vexpr'#288.

    $ echo 'vexpr + 1 2' | s-nail -#:/
    00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000011
    03 | 0x3 | 3
    $ echo 'vput vexpr resvar + 1 2;echo $resvar' | s-nail -#:/
    3

  We actually start walking (*?*#331, *^*#333).

    ? vput vexpr res regex 'bananarama' 'Bana(.+)' '\$1\$0'
    ? echo $?/$^ERRNAME :$res:
    1/NODATA ::
    ? vput vexpr res iregex 'bananarama' '(.+)rama' '\$1\$0'
    ? echo $?/$^ERRNAME :$res:
    0/NONE :bananabananarama:

  The command `vpospar'#289 can be used to manage the stack of
  positional parameters, i.e., much like "set --".
  It also offers the possibility to save and restore the stack to
  and from variables.  Etc.

  Btw., to contact the maintainer (make.rc variables
  VAL_CONTACT_WEB and VAL_CONTACT_MAIL):

    ? echo $contact-web; eval mail $contact-mail

- `if'#200 no longer performs automatic number conversion, we
  use the explicit -lt, -gt etc. syntax of the sh(1).
  Note: `if' will change to be almost identical to sh(1) if(1),
  so please ensure proper test bracketing, even if it is less
  convenient.

  Moreover, the default string comparison mode has changed to
  case-sensitive, just like in the shell.  This is because in the
  future this crux with trigger characters will vanish and `if'
  etc. will simply slurp in already expanded shell tokens, it will
  act like the shell in that respect.  We have modifiers, though,
  yet only "@i" for case-insensitivity, also for regex matches:

    LC_ALL=C
    i=`LC_ALL=C.utf8 s-nail -:/ -# -X '
       \define cset_test {
          \if [ "${ttycharset}" @i=% utf ]
             \echo $LC_ALL
             \xit 0
          \end
          \if [ "${#}" -gt 0 ]
             \wysh set LC_ALL=${1}
             \shift
             \eval xcall cset_test "${@}"
          \end
          \xit 1
       }
       \call cset_test C.UTF-8 POSIX.utf8 POSIX.UTF-8 \
          en_EN.utf8 en_EN.UTF-8 en_US.utf8 en_US.UTF-8
   '`
   [ $? -eq 0 ] && UTF8_LOCALE=$i

  Please note the `eval' in 'eval xcall cset_test "${@}".  This is
  a difference of S-nail/mailx and the sh(1)ell that will remain,
  as documented in "COMMANDS"#20: whereas the shell implements
  a language and performs standardized expansions on the line
  until finally the command is called, S-nail will decide the type
  of command line parsing dependent on the seen command, and will
  then perform a single expansion.  Therefore "${@}" will expand
  to multiple arguments if $# is greater 0, but it will expand to
  the empty string otherwise, which is not furtherly expanded away
  since it is meaningless like it is in the shell: therefore $#
  will be 1 (the empty string) not 0.

- Using an explicit proto:// prefix should get you the desired
  thing apart of *newfolders*#447, e.g.:

    ? File maildir:///tmp/x.mdir
    ? copy * file:///tmp/x.mbox

- New variable *record-files*#486 can be set to extend the meaning
  of *record*#485.  *record-resent*#487 was there already.

- New variable *ifs*#413 acts a bit like the sh(1)ell's $IFS for,
  e.g., the new `read'#233 command.

  There is a `readctl'#235 command which can be used to manage
  the active channel used by `read'#233.

- The `~' alias for `call'#139 is gone.

- `mimetype'#208 only allows specification of a single type per
  call, on the other hand no need to quote that.

- `mimeview'#212 must now be used explicitly to look at any
  non-text MIME part, for normal display etc. purposes we only
  support "copiousoutput"#606 MIME handlers.

- New *socks-proxy*#523 can be used to proxy all network traffic
  over a SOCKS5 proxy.  (Gaetan Bisson)

ChangeLog
^^^^^^^^^

- The manual has seen another major overhaul, all the variables
  are now documented in a single, sorted list, and many
  clarifications should have been added.  I hope it has become
  a better read.
  (Predrag Punosevac, Michael Convey, Hariskar, Rudolf Sykora,
  Respiranto, Thomas Dickey, Donald Mugnai)

- To support RFC 1524 a.k.a. .mailcap files (see below) many
  "trigger"-characters have been added for *pipe-TYPE/SUBTYPE*#461,
  which may (rarely) affect existing values.
  The .mailcap support itself is not yet implemented.

- *mime-counter-evidence*#437 gained bit 4 (perform proper in-depth
  content inspection as necessary; set to 0xE for all bits).
  (Aharon Robbins)

- Maildir paths are now created recursively as necessary.
  (Justin Ellingwood)

- -M#69 and -m#70 options have been added to enforce a special
  send mode that will flag standard input / the given file with
  the specified / detected MIME 'Content-Type:'.  This can be used
  to directly send, e.g., HTML log output.
  (Viktor Szépe, Ralph Corderoy)

- Disallow symlinks on writable files.  Note this requires
  O_NOFOLLOW support for the operating-system-call open(2), but
  which has been standardized a long time ago.
  (Matthew Dillon)

- `retain'#248, `ignore'#201 etc. now differentiate in between
  From (the From: header) and From_ (the MBOX ident).

  In fact we now have a new `headerpick'#194 command which
  is a multiplexer for all retain and ignore lists used, call it
  without arguments to see the current setting(s).
  In v15 only `headerpick' and the standard-imposed wrappers
  `retain' and `ignore' will remain, all other wrappers will
  vanish.  Regular expressions can now be used if available:

    ? headerpick
      headerpick type retain blahblahblah cc date from \
        mail-followup-to message-id openpgp reply-to subject to \
        user-agent
      #headerpick type ignore currently covers no fields
      #headerpick save retain currently covers no fields
      headerpick save ignore '^Original-.*$' '^X-.*$' '^DKIM.*$'
      headerpick forward retain cc date from list-id \
        mail-followup-to openpgp reply-to subject to
      #headerpick forward ignore currently covers no fields

- `top'#275 has been rewritten completely, `Top'#274 is new.
  It uses a built-in set of retain/ignore headers, but it is
  possible to register a custom set via `headerpick'#194.
  Also, *toplines*#557 has been extended a bit and the new
  *topsqueeze*#558 variable may pimp your `top' experience.

    ? headerpick top retain add subject
    ? top
    [-- Message  1 -- 87 lines, 4791 bytes --]:
    Subject: Re: I can't dist to myself

    I wrote:
        3.22. bounce_delivered

- `features' has been dropped, `version'#287 extended.

- The *prompt*#476 handling has changed: we lost the capability to
  expand \?, \@ and \$, instead new "private" variables *?*#331,
  *account*#342, *mailbox-resolved*#426 and
  *mailbox-display*#425 have been introduced, and the prompt
  is completely shell expanded (thus twice with `wysh' or in v15),
  as if dollar-single-quote quoted.  We do support the reverse-
  solidus escaped bracket notation for embedding characters which
  should not be counted when calculating the width of the prompt.
  The `colour'#148 command has a slot for the prompt colour.
  We gained *prompt2*#477 as a second level prompt.

    ? var prompt
    wysh set \
      prompt='?\${?}!\${!}[\${account}#\${mailbox-display}]? '

- The filename "-" can be used as a receiver, e.g.,

    $ echo Hey,\ you | s-nail -:/ -Sexpandaddr -sUB -

- The -s#77 command line option, the `~s'#324 command escape
  as well as the corresponding slots of `~^'#305 will actively
  strip [\r\n] from their value (Debian #419840).

- New `read'#233 and `echoerr'#168 commands, mostly for
  *on-compose-splice*#454.
  But also `echon'#169 and `echoerrn'#170, which do not write
  a trailing newline.

- New variable *r-option-implicit*#483 may be helpful to those
  who regulary need the functionality of the -r#75 command
  line option.  (Felipe Gasper, Martin Neitzel)

- By using new "pseudo-URLs" one can automatize the use of S/MIME
  keys / (certificates / intermediate include certificates) with
  passwords.  E.g., to drive bob@exam.ple, set
  *smime-sign-cert-bob@exam.ple* to the private key / certificate
  pair as usual, the password lookup will then be performed for
  bob@exam.ple.smime-cert-key, bob@exam.ple.smime-cert-cert and
  bob@exam.ple.smime-include-certs.
  Like this the password can be stored in an encrypted .netrc file
  when *netrc-lookup*#445 and *netrc-pipe*#446 are set, or it may
  be stored in an encrypted resource file that has been loaded via
  `source'#266 as a simple *password*#459 variable.

  Note that the prompting that happens as a last resort of
  password lookup will still interfere with a possibly running
  $PAGER#587 instance, dependent on the setting of *crt*#376, of
  course.  Proper job control handling and recognizing that we are
  running $PAGER when doing that prompt is a TODO for v15.  Sorry.

- Some commands, like `set'#254, `help'#197, `list'#202,
  `mlist'#210 etc., now react upon the setting of *verbose*#564
  and(/or) *debug*#380.

- `write'#291 uses iconv(3) as appropriate.

- *mbox-rfc4155*#429 has first been dropped, and was then
  reintroduced with different semantics.  Because, it can be
  helpful if a messed up MBOX is read, in which case we henceforth
  will warn you and point you to this:

    ? define mboxfix {
      \localopts yes; \wysh set mbox-rfc4155;\
        \wysh File "${1}"; \eval copy * "${2}"
    }
    ? call mboxfix /tmp/bad.mbox /tmp/good.mbox

  P.S.  Here you see how weird the current thing still is, in v15:

    ? define mboxfix {
      localopts yes; set mbox-rfc4155; File "${1}"; copy * -- "${2}"
    }

  And also in v15 we will not apply (proper) so-called MBOXO
  quoting, but instead (simply MIME) re-encode mail messages.

- `call_if'#140 is new and, different to "? ignerr call", silent
  and not messing with the return status.

- The new *smime-ca-flags*#509 and *ssl-ca-flags*#536 can be used
  to fine-tune X509_STORE_set_flags(3) a.k.a the X509 CA
  certificate verification.

    ? set ssl-ca-flags=partial-chain
    ? wysh set smime-ca-flags="${ssl-ca-flags}"

  Also, *ssl-curves*#545 for TLSv1.3.

- Socket connections use TLS S(erver)N(ame)I(ndication) as
  appropriate (RFC 7817).

- `alternates'#133 checks arguments and supports `vput'#117.
  It by default no longer replaces but appends alternates, unless
  *posix*#474 mode is active.  There is a new `unalternates'#134
  command to remove alternates.

- A new `charsetalias'#143 command.  (Pietro Cerutti, mutt#3925)

- New commands `filetype'#181 and `unfiletype'#182: in the future
  we will no longer know any builtin filetypes, in fact we already
  simulate .gz etc. via the new mechanism as necessary:

    ? filetype \
       bz2 'bzip2 -dc' 'bzip2 -zc' \
       gpg 'gpg -d' 'gpg -e' \
       gz 'gzip -dc' 'gzip -c' \
       xz 'xz -dc' 'xz -zc' \
       zst 'zstd -dc' 'zstd -19 -zc' \
       zst.pgp 'gpg -d | zstd -dc' 'zstd -19 -zc | gpg -e'

- `~<'#300 now offers a "- [HERE-delimiter]" mode for pasting etc.
  (Ralph Corderoy)

- `exit'#178 and `quit'#232 take an optional exit status.
  (That is not fixated yet, though.)

- We have a useful -h / --help output.  (Doug McIlroy)

- *encoding* obsoleted in favour of new *mime-encoding*#438, which
  now defaults to base64.

- *allnet*#344 now works (broken since nail 10.00, 2002-09-29).

git(1) shortlog (abbreviated)
'''''''''''''''''''''''''''''

f01291d extract_date_from_from_(): dig more invalid MBOXes (Antonio Radici)..
df8768b Add *mime-counter-evidence* bit 4 (Aharon Robbins)..
d3fe980 Ftmp(): drop "mode" argument (not wrong: Mike Frysinger)..
86159db nail.1: we support searching, really (Predrag Punosevac)
5b61a08 nail.1: talk about address lists (again) (Michael Convey)..
0eeffc4 nail.1: try improve states / MBOX etc. relation (Michael Convey)
43ea039 nail.1: what is an environment variable (Michael Convey)
13e0804 nail.1: fix typo (Hariskar (archlinux Wiki))
03d6af5 nail.1: more on sortability (Rudolf Sykora)..
4da9043 Not "binary", but "boolean" variables! (Predrag Punosevac)..
c85f56d Support :d specifier for at least `from' (Martin Neitzel)..
b12e1ed Be more friendly when composing mails (Martin Neitzel)..
b50eac0 nail.1: use display/show not type/print (Michael Convey)..
6feafaf Add `search' alias for `from' (Predrag Punosevac)
a4e2612 Support 256-colour terminals (Gavin Troy)
8655aff Error framework: print UAGENT prefix (ident in pipes; Salvatore
        Bonaccorso)
e96baaa Introduce $LOGNAME, the POSIX equivalent of $USER (Todd C. Miller)
76e6364 Add `customhdr' (Sergey Matveev)..
ad58c91 Support *customhdr*, too (Sergey Matveev)..
6322e0a Support _any_ user header via ~e (Sergey Matveev)..
5d52578 Add -: command line option (Robert Elz)..
53b5f07 README: use git(1) --single-branch (Mantas Mikulėnas)
420131f Fix mispelling: can|to be send->sent (Respiranto (archlinux Wiki))
d6902e1 Add *on-compose-{enter,leave}* hooks (Jens Schleusener, Rudolf
        Sykora)..
abf2e5d .netrc: support comments (Walter Alejandro Iglesias, Ralph Corderoy)..
37e0c26 nail.1: .netrc comma separator was in original Berknet parser! (Ralph
        Corderoy)
40522c3 nail.1: use -v option to cat(1) if available (Thomas Dickey)
d8f7cd7 (BWDIC!) Redefine -u / $LOGNAME / $USER (Afan)..
e337e00 Support expansions in $MAIL!; more on `account's (Afan)..
d596d74 Compare *newfolders* case-insensitively (Justin Ellingwood)..
57744f9 Redefine *folder* / getfold->folder_query() / *HOME* (Justin
        Ellingwood)..
3c57c83 n_path_mkdir(): create recursively as necessary (Justin Ellingwood)
0bbe981 nail.1: fix spelling errors as by igor(1) (Ingo Schwarze)
f1a775b Add -M and -m options (Viktor Szépe, Ralph Corderoy)..
1bd8e48 Add *umask*, and set actively (Walter Alejandro Iglesias)..
6b1cd93 Now with *umask*, just drop fchmod(2)++ calls (Walter Alejandro
        Iglesias)
ba22166 Change make targets; add $MAILJOBS; don't track $DESTDIR (Gaetan
        Bisson)..
cd244b1 Add WANT_CROSS_BUILD make.rc option (Juan RP)..
95141f6 Tweak VERBOSE handling (William Yodlowsky)..
d74a18a mk-conf.sh:path_check(): skip any "fakeroot" path (Hilko Bengen)
10990e4 Add n_O_NOFOLLOW, disallow symlinks for writable files (Matthew
        Dillon)..
df4954c Add $SOURCE_DATE_EPOCH (reproducible-builds.org; Colin Watson)
dc92f2c savedeadletter()->sendout.c; tweak POSIX compliance (Ralph Corderoy)
20f3cd2 nail.1: more explicit `set' references instead of saying 'Set' (Donald
        Mugnai)..
2d53b46 url_parse(): better take better care for path parts (Stephen Isard)..
21f0eaa mk-conf.sh: find terminfo on Sun (Thomas Dickey)..
e4ddaa8 Change n_iconv*() protos, add enum n_iconv_flags (Ralph Corderoy)..
1587069 FIX [44cec1f] (Fix "address" message specifications (John Dodson))..
e40e181 nail.1, nail.rc: set *sendwait* by default (Ralph Corderoy)
7adcf99 `write'++: !interactive: urlxenc() attachment paths (Ralph Corderoy)..
b14aae7 `write'++: !interactive:.. But now, really (Lyndon Nerenberg, David
        Levine)..
5270bf1 Simplify *folder* (implicit trail solidus) (Stephen Isard, Ralph
        Corderoy)
a638bcf Add *typescript-mode*, set it for -# (Ralph Corderoy, Martin
        Neitzel)..
053e19f Add *inbox* (Stephen Isard, and Jürgen Daubert)..
20e3240 Add OPT_ALWAYS_UNICODE_LOCALE (Predrag Punosevac)..
14b5a3a Make combinetime() overflow safe (Vincent Lefevre)..
7a657d9c cc-test.sh: add S/MIME disproofs via smime(1) (Sven Neuhaus)..
ae86c884 cmd1.c:__hprf(): compensate for add. bytes of UTF-8 seq.(s) (Martin
        Neitzel)
975e6869 (BWDIC!) Only rm sysboxes, unless *posix* (Walter A. Iglesias,
        trondd)..
81e33751 Throw away file_expand() (Ismael Bouya)..
5ae556f8 Add *r-option-implicit* (Felipe Gasper, Martin Neitzel)..
33709163 nail.1: some more words for *inbox*, and such sort (Stephen Isard)
88c19049 mk-release.inc: place OpenPGP signatures last (learned from Paul
        Eggert)
0ede309c Rudely fix the RFC 5322 dot-atom, the "Dr. Problem" (Dr. Werner Fink)
f797c27e FIX privsep.c, yes, vulnerability (wapiflapi)..
f2699449 FIX privsep.c vulnerability, II (forgot hostname!) (wapiflapi)
303d46cd FIX [3d7835fc] aka `~^' attachments, especially Content-ID: (Ralph
        Corderoy)
4ce4eb55 privsep.c: and just verify the box is also in CWD (wapiflapi)
25d9e6e2 Generate Content-ID: as applic. (Ralph Corderoy, Ken Hornstein, David
        Levine)
6409c886 nail.1: clarify/FIX doc. of \cX (Noel Chiappa, Random832)..
5a1c023c nail.1: furtherly clarify doc. of \cX (Doug McIlroy)..
d33294c2 mk-release.inc: use %B for $DATE_MAN (Baptiste Daroussin)..
eafa9411 (BWDIC!) Defaults for *datefield{-markout-older}* (Debian #855582;
        r.ductor)..
5ab93627 MLE: set FEXP_NOPROTO for mle-complete expansions (Ralph Corderoy)
ada72661 ~<: add "- [HERE-delimiter]" for pasting etc. (Ralph Corderoy)
d4d46c42 Add `charsetalias', and use it (Pietro Cerutti, mutt#3925)
65e2b75f Redefine VIP handling of variables (Ralph Corderoy)..
162cafb7 *mime-counter-evidence*, bit 4: allow "soft" controls (Jörg
        Schilling)..
90861930 Readd removed fflush()/fseek() in between read and write..
  [That should credit Jörg Schilling indeed]
aae47707 Tweak previous, and include O_CREAT in "a+" (Jörg Schilling)..
3e4441f8 a_main_usage(): new synopsis (Doug McIlroy)
8f61025b FIX icase hmaps (`charsetalias', `filetype', `mlist') (rain1)
2e6a811d a_termcap_init_var(): numerics not necessarily decimal (Thomas
        Dickey)..
9d58267f config.h+: add n_PATH_DEVNULL, use it instead of hardcoding (Xin LI)
8075cf00 Support *socks-proxy* (SOCKS5) (Gaetan Bisson)

Appendix
^^^^^^^^

The complete changelog of commits in between two versions OLD and
NEW can be inspected by using the git(1) `log' command:

  $ git log --reverse --topo-order --abbrev-commit OLD..NEW
  # Only topic branch headers (--no-merges for content commits only):
  $ git log --oneline --reverse --topo-order --merges OLD..NEW
  # Same, but truly accessible:
  $ git log --oneline --reverse --topo-order --merges --parents OLD..NEW |
    while read c1 c2 c3 c4 c5 c6; do
      printf "%-24s: \$ git log --oneline --no-merges %s ^%s\n" \
        "${c6}" "${c1}" "${c2}";
    done

Entries for releases before v14.9.0 have been cut off and can be
found in the git(1) repository:

  v14.8.0 - v14.8.16: $ git show v14.8.16:NEWS
  v13     - v14.8.5 : $ git show v14.8.5:NEWS
  9.0     - 12.5    : $ git show heirloom:ChangeLog

Also accessible via HTTPS?, just replace X.Y.Z accordingly:

  \https?://git.sdaoden.eu/cgit/s-nail.git/tree/NEWS?h=vX.Y.Y

For even older releases you need to look into the [timeline]
branch, but no changelog has been administrated for them.

# s-tm-mode
