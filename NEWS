S - n a i l  N e w s
====================

  The big big MIME and send layer rewrite will come and cumulate in
  v15.0, most likely late (maybe christman ,) 2014.
  Until then there is one more minor version to be expected, one that
  fixes thread sorting, thread selection, adds a %n format for
  *headline* and other minor stuff that springs into existence in the
  meanwhile.  v14.4 will be released this year, but it may come late.

v14.3, 2013-06-03
-----------------

Thanks to Gavin Troy (gavtroy AT gmail DOT com) who inspired the @ and
@& pipe-command prefixes.

Random notes
^^^^^^^^^^^^

- S-nail has been registered at Coverity Scan, and the third build
  (after topic branches *coverity-444* and *coverity-444.2*) produced no
  more errors.  (<http://scan2.coverity.com/projects/444>.)
  (Then i used POP3 and IMAP and fixed some SIGSEGV. ;)  Still didn't
  look at S/MIME, Maildir, caches etc... o()

- S-nail v14.3 doesn't produce any spurious linker warnings on
  OpenBSD 5.3; all (correct!) use cases of strcpy() and strcat() have
  been replaced.  [7bdf330, 2c8d7cb]

- This is the first release with a (though very short) review -- i'm
  slowly getting comfortable with the code.  (But i'm too stupid to
  perform reviews on patches, 'always did reviews on C++/Perl/xy
  classes.  Aaah, how beautiful ... objects.)

ChangeLog
^^^^^^^^^

- It is now possible to "call" macros without using the `call' command
  by prefixing them with a tilde, as in

    ? define au {
      echo auau
    }
    ? ~au
    auau
  [93ea8acd]

- Added the *pop3-bulk-load* option.
  Yes, there are mailing lists etc. which use plain text email, and,
  there, headers are often more data than the body, so it doesn't make
  sense to download the headers twice (unfortunately POP3 doesn't
  support a BODY command; if only it would support a RETRDELE command..)
  [978e13a7]

  And yep, from this changeset on i personally use S-nail even over the
  network, no longer my stale and incomplete S-Postman.  And i can tell
  you, this damn thing is so silent, i always set *verbose* not to go
  grazy ... but .. i hate to say it .. the healing will take time.

- POP3 will now try to use APOP authentication automatically; thus the
  *use-apop* stuff has been replaced by *pop3-no-apop* options (just in
  case there are POP3 servers which advertise they support APOP but in
  fact fail to do so; anyone?)  [6c3c5575]

- Some IMAP segmentation violations have been fixed:

    ? fi imaps://user1@localhost
    Password:Interrupt            <- CNTRL-C
    ? set imap-auth=cram-md5      <- hey, 'forgot to set correct auth
    ? fi imaps://user1@localhost
    IMAP write error: error:140D00CF:SSL routines:SSL_write:protocol is shutdown
    Segmentation fault

  And also, when *folder* was set to an IMAP account but hasn't been
  opened yet, and no IMAP account ever has been opened, a string
  comparison against a NULL pointer yet caused a SIGSEGV, too.
  [417c01f, 413c23d9]

- `set folder=' now tolerates `%:' and expands PROTOs stuff etc.:

    ? short xp %:imaps://user1@localhost
    ? set folder=xp

  Pure convenience so that it doesn't need to be typed twice (still no
  completion in sight...).  Note that setting *folder* to a POP3 box
  will now be actively rejected.  [b12b17f5]

  NOTE: while implementing this i've detected another dead-end
  miscondition in S-nail -- you really should ensure that your target
  folder/box is connected before you leave your current POP3/network
  based folder, if there is data to be moved to the target (i.e.,
  mbox).  This problem will persist for a long time due to the way the
  entire codebase functions; i hope i can find a short/mid-term
  solution, but the real healing will take years.  The mentioned
  solution would at least make S-nail interruptable, currently we get
  stuck and interrupts are blocked...

- If you're using S-nail on Mac OS X and have seen some segmentation
  faults when expanding shell stuff then you may be pleased to hear that
  S-nail now works around an Apple bug.  [63273772]

- The builtin mime.types have been corrected and a lot of new ones have
  been added.  New data from
  <http://svn.apache.org/viewvc/tika/trunk/tika-core/src/main/resources/\
  org/apache/tika/mime/tika-mimetypes.xml>, thanks!  [8072fcb6]

- BEWARE: handling of command line arguments has changed a bit!

  1. The -D, -d, -E, -i, -N and -v command line options are now
  implemented by means of setting the respective option, as via -S.
  (This means that from now on resource files can only *temporarily*
  overwrite command line arguments.)

  2. The -I and -T command line arguments have been dropped.
  It seems Gunnar Ritter stopped developing nail/Heirloom mailx once he
  started implementing Newsreader functionality.  It'll take a long time
  until we get there, so for now drop all the Newsreader stuff.

  3. Handling of -r has been changed.  E.g.:

    s-nail -A test -Snoeditalong -r 'La mort est <fem@me>' -d
    ? set from=bummer@m1.com
    ? m t1
    Subject: s1
    .
    Sendmail arguments: "sendmail" "-i" "-r" "fem@me" "t1"
    ? set from=bummer@m2.com
    ? m t2
    Subject: s2
    Sendmail arguments: "sendmail" "-i" "-r" "fem@me" "t2"

  ...

    s-nail -A test -Snoeditalong -r '' -d
    ? set from=bummer@m1.com
    ? m t1
    Subject: s1
    .
    Sendmail arguments: "sendmail" "-i" "-r" "bummer@m1.com" "t1"
    ? set from=bummer@m2.com
    ? m t2
    Subject: s2
    Sendmail arguments: "sendmail" "-i" "-r" "bummer@m2.com" "t2"

  [*main-fun-cleanup* topic branch]

- *smime-sign-include-certs-** stuff works again, oops..  [9a8597c6]

- A whole lot of smallest and small fixes due to registration at
  Coverity Scan, as project 444.  Error handling in S-nail is ridiculous.
  [*coverity-444* and *coverity-444.2* topic branches.  The sheer number
  of fixes was the reason to sit down and go for unplanned S-nail v14.3]

- *idna-strict-checks* has been dropped.  It's silly to have in a MUA,
  especially given that GNU LibIDN doesn't ship with a lot of rules.
  We were able to drop quite some code (and a use-after-free, too :().
  [c81fd41d]

- The ~p tilde command displays attachments more verbose.
  Until the big big MIME and send layer rewrite :) this is intermediate
  since until then we do not really know neither MIME type nor charset
  of an attachment at the time this is displayed (for sure).  Yet
  i think it's nicer to show what we have than keep it the way it was.
  [60e70463]

- @ and @& shell command prefixes have been added for the pipe-MIMETYPE
  mechanism.  The former suppresses filters if multiple messages are
  displayed at once, the latter adds asynchronous program execution on
  top of that.  E.g., to display PDF documents, but only if you
  *explicitly* address the message *alone and by itself*, and without
  blocking S-nail and the $PAGER, do:

    set pipe-application/pdf="@&cat >"${TMPDIR}"/s-nail${$}.pdf;\
      mupdf "${TMPDIR}"/s-nail${$}.pdf; rm "${TMPDIR}"/s-nail${$}.pdf"

  (Inspired by Gavin Troy.)  [a8d724b3]

  Note: most of that had been posted to nail-devel@ already, but it was
  tweaked ([251b636]) so that you now *really* have to say `p MSGNO' to
  get there.

- The NETLESS CONFIG= has been removed; it is almost identical to
  MINIMAL now (i.e., without WANT_JUNK and WANT_SCORE).

- WANT_JUNK and WANT_SCORE have been disabled by default.
  They don't seem to be too useful; i hope i can implement
  a SpamAssassin hook for (downloaded) mail messages for v14.4.
  If so, expect these two "modules" to become removed completely.

v14.2.2, 2013-05-01
-------------------

Another unplanned (minor) bugfix release after Gavin Troy (gavtroy AT
gmail DOT com) pointed out that MIME CTE decoding was broken, who
i therefore want to give a lot of prominence right here.

- Fix MIME content decoding which has been broken by [01c0e135].
  [882caedd]
  (Gavin Troy.)

v14.2.1, 2013-04-30
-------------------

An unplanned (minor) bugfix release after i've found two bugs today and
heard from Jérémie Courrèges-Anglas (jca+nail AT wxcvbn DOT org) that
there exists a S-nail OpenBSD package.

I want to give prominence to the following people that helped to
improve S-nail(1) during this development cycle, in order of
appearance: Dirk Peters (peters AT schwertfisch DOT de).

Thank you very much, and best from Germany!

- Some warnings of newer clang(1) versions were silenced, including yet
  another alloca(3) problem (see *memtracer* topic branch in v14.0
  series).  [6f846efe]

- Tweaking the MIME boundary detection left a little hole that could
  cause boundaries not to be detected, as has been shown by a Microsoft
  Word generated mail on the ICU list.  [11e5fb5b]

- A format string could overflow bounds if unrealistic
  (18446744073709551615) line numbers or message sizes would have been
  produced.  [faa65c40]

- An algorithmic error could cause overlong lines which wrapped around
  to the next display line.  [ade52660] 
  (Dirk Peters.)

v14.2, 2013-03-15 [v14.1, 2013-03-12]
-------------------------------------

I want to give prominence to the following people that helped to
improve S-nail(1) during this development cycle, in order of
appearance: Martin Neitzel, Christos Zoulas, Stephen Isard, jgw@txo.org
and Gavin Troy.

Thank you very much, and best from Germany!

+ v14.2 differs from v14.1 only by one commit, one that fixes
  (mime_fromhdr(): partial rewrite using n_iconv_str(), 2013-03-12),
  which i hastily implemented just hours before the release of v14.1,
  and simply shouldn't have made it (into there).
  The v14.1 tarball has been removed from the server.

- A fix for the quoted-printable codec: "message truncation" occurred
  when a mail maliciously used a soft linebreak to escape the linebreak
  of a completely empty line.
  (That resulted in 0 written and 0 leftover bytes, a condition that was
  declared erroneous back in november 2012 when i started handling I/O
  errors.)

- The "folders" command will work again when given an argument.
  A fault of mine introduced in (cmd1.c: expand() may fail, 2012-10-23).

- The Base64 codec has been touched again, and we are finally capable to
  perform sequential decoding; this was targeted for the MIME/send layer
  rewrite, but it actually was possible today.
  The result as seen in ps(1), running on the Base64 encoded HTML5
  standard (4622545 bytes HTML, with a NUL appended to force Base64
  encoding, resulting in a 6244793 bytes email):

   7420 s006  S+    2:22pm 0:10.65 plain-nail -f HTML5
   1440 s006  S+    2:23pm 0:00.36 ./s-nail -f HTML5

  (So the only thing that is left for a good throughput is sequential
  decoding of quoted-printable encoded parts that maliciously use soft
  linebreaks to convert an entire part to a single line.  And i've seen
  that from Apple Mail.)

- New option: *mime-allow-text-controls* (rather long manual entry).

- *smtp-auth-password-user@host* and *smtp-auth-user-user@host* will
  finally work!
  (Reported by jgw@txo.org in November 2011, fixed by Gavin Troy in
  January 2012.)

- Most *headline* formats now do support the '-' left-alignment flag.
  Note that you most likely have to change your *headline* accordingly.
  (The still missing %n format is one reason why there will be v14.2.)

- *datefield* and *datefield-markout-older* can now be set to
  strftime(3) format strings (except %n).
  (From Stephen Isard's wishlist.)

- A possible SEGV has been found and also fixed by Stephen Isard.
  (The "legendary" cross-world stereo fix!)

- Wow!  S-nail will finally compile on GNU based Linux systems like
  Slackware 14 etc.  (Found while hunting bug reported by
  Stephen Isard.)

- New option: *datefield-markout-older* can be used to choose
  a different date display for mails that are older than six months,
  in equal spirit to what POSIX describes for the -l option of the ls(1)
  command (Stephen Isard).

- (Exotic) Years are (would) now (be) interpreted correctly according to
  RFC 5322, 4.3.

- CRAM-MD5 usage has been fixed.

- *folder* updates are now tracked when set, and we will show the
  realpath(3) name of it, showing PREFIX..SUFFIX if that wouldn't fit on
  the display.
  Tracking updates made it also possible to perform other more expensive
  tasks when setting *folder*, so that it is now possible to do
  something like:

    :set folder=$HOME
    :set folder=~

  et cetera (both ideas by Christos Zoulas).

- Bugfix for the ~@ tilde-escape in non-interactive mode.
  (readtty(): quick shot: work in pipelines (on non-TTY).., 2013-01-25)
  introduced the possibility to "read data from the terminal" (STDIN
  that is) in non-interactive mode.
  The manual documents that attachment input must be terminated with an
  empty line, but if that had been omitted, as in the example below, we
  would have yet entered an endless loop.

     $ cat <<_EOT | /s-nail -~ -s boom ./OUT
    ~@
    test.c
    charset
    _EOT

- Alias expansion will now be performed for members of Reply-To: fields
  (Martin Neitzel).

- Decoding quoted-printable will now be more relaxed.
  (Even though the standard says that users should be given a hint when
  input is not absolutely clean; a possible warning will be added later,
  when we have an error message ring.)

- New option: *mimetypes-load-control* can be used to control which of
  the mime.types resources will be loaded.

- The builtin default mime.types have been extended a bit.

v14.0, 2013-02-10
-----------------

I want to give prominence to the following people that helped to
improve S-nail(1) during this development cycle, in order of
appearance: John Dodson, Gianluca Ramunno, and Anon Ymous from the
NetBSD project.

Random notes
^^^^^^^^^^^^

- Encoding defaults to *quoted-printable* not *8bit*.
  This has no technical background except that i think it's the better
  default.

- Small progress for the "getting stuck due to the current folder
  becomes inaccessible due to whatever reasons"  problem.
  (schdir(): realpath() local files before leaving CWD.., 2013-01-08)

- The names of temporary files have changed.  Whereas not all uses of
  temporary files already use really meaningful names, it has yet become
  possible to use the pattern "*mail-*"; or, to be compatible with
  NetBSD Mail(1) in one go, "*mail*".  (E.g., in my ~/.vimrc you'd read:
    :au   BufRead,BufNewFile *mutt*,*mail* setl fenc= | setf mail
  [the *mutt* is a leftover from times when i've used MUAs that suck].)

ChangeLog
^^^^^^^^^

- The Quoted-Printable MIME handling has been rewritten completely.
  We now correctly encode files with the MS-DOS newline sequence (CRLF).
  (Part of the *mime-cte* topic branch.)

  S-nail(1) continues to be able to handle text messages and text
  attachments without a trailing newline, but because these
  Content-Transfer-Encoding related things are now handled by the C-T-E
  layer instead of by sendout.c a text message body that comes in as
  part of a complete message via the -t command line option will loose
  the missing final newline (i.e., it'll gain one).
  This problem does *not* occur when *only* the message body comes in
  via STDIN, as in 'cat FILE | s-nail', but *only* when the -t option is
  used.
  (sendout.c: does no(t/ longer) know about CTE internals!, 2013-02-09)

- Filename arguments for -a are now processed *after* all the resource
  files have been loaded etc., so that the usual "folder" specifics can
  be used (provided that proper care for shell quoting was taken).
  ((main(): delay -a processing.., 2013-01-10), as a part of the
  *mainaflags* topic branch.)

- (d38c5bd, When the write command asks.., 2004-11-23) added support
  for pipes when saving attachments during a "write" command.
  It however used the wrong SIGPIPE signal handler; e.g.:

    Enter filename for part 2 (application/x-gzip): |exit
    Segmentation fault

  Of course, it still performs a jump and that most likely leaves memory
  chunks behind, thus causing some memory leaks.  This will be
  a long-term problem (you may want to read [mime.c:fwrite_td(): TODO
  notes on unfixable leaks, 2013-01-14] for more).
  (send.c:sendpart(): fix longjmp() SIGSEGV.., 2013-01-29)

- Fixed a name quoting regression that i've introduced in
  (Rewrite *extract().., 2012-10-20), that would have caused
  "x \"y\" z" to become "x"y" z" instead of "x "y" z".
  (S-nail still does not really have RFC compliant parsers, just as
  NetBSD Mail(1) has, i.e., there are structured and unstructured fields
  etc...  I hope i can provide them in v15.0.)
  (names.c:yankname(): fix quote regression.., 2013-01-29)

- The IDNA conversion now assumes domain names are specified in
  *ttycharset*, rather than in the LC_CTYPE locale charset.
  I.e., it integrates into the usual character set specifications.
  (IDNA: honour *ttycharset* for domain names, 2013-01-18)

- The new *editalong* variable will automatically spawn an editor when
  composing a mail in interactive mode, just as if `~e' was given.
  (Add new *editalong* variable, 2012-01-07)

- The manual has been converted to mdoc.
  (The manual has been converted to mdoc, 2012-12-28)

- The ~@ tilde escape, when given filename arguments, will treat the
  arguments as a comma-separated instead of a whitespace-separated list.
  (collect: change separator of ~@ tilde escape.., 2012-12-28)

  The interactive mode of ~@ has also been changed, rather massively.
  Please do reread what the manual says.
  ((collect: support multiple attachment charsets.., 2013-01-23), as
  part of the *attach* topic branch.)

- Thanks to Gianluca Ramunno (ramunno DOT gianluca AT gmail DOT com)
  S-Nail will no longer try to issue a STARTTLS command when it is about
  to establish a SMTPS connection, a task that logically fails since the
  connection is already secured.
  (Interestingly the nail codebase performs the necessary test for IMAP
  and POP3 already.)
  While here the undocumented nail v11.0 *smtp-use-tls* legacy option
  has been removed.
  (Fix SMPTS with a set *smtp-use-starttls*.., 2012-12-22)

- The RFC 4155 compliant MBOX quoting is now exclusively used, the
  shitty *posix-mbox* variable has been removed again.
  (Shitty because i've implemented RFC 4155 compliant MBOX quoting and
  tested it, then added *posix-mbox* for those who liked the old
  behaviour and did not re-test -- the final code path was buggy.)

  In mails newly created and saved by S-nail(1) no From_ quoting at all
  will be used no more, but instead the rewritten MIME file classifier
  will detect unquoted From_ lines and enforce quoted-printable encoding.
  (This is an approach that is S/MIME compatible all through the way as
  the file data is not modified at all, but only encoded, so that the
  data checksum is not changed.)

  In yet existent mails that S-nail copies or moves around without
  reclassification an RFC 4155 compliant From_ line detector will apply
  MBOXO quoting (prepend a single '>') as necessary.
  Different to the old MBOXRD behaviour S-nail will neither quote yet
  quoted From_ lines ('>>From xy' -> '>>>From xy') nor will it unquote
  one quote level when reading etc. mails ('>> From xy' -> '>From xy').
  As a result the code could be simplified.

  This changeset also incorporates a fix for NetBSD PR bin/47453, as
  reported by Martin Brandenburg.  I.e., some mailers, noticeably
  UW-imap (with MBX format only?), use non-compliant From_ lines with
  RFC 822 date specifications.  Be aware of 'em.
  (RFC 4155 MBOX, and drop *posix-mbox* and foldergets().., 2013-01-06)

- *rfc822-show-all* has been removed.
  It didn't work properly for more complex MIME structures, like
  message/rfc822 messages with attachments etc., just as i've seen today
  on the file(1) mailing list.
  So, instead of hacking it now i've dropped it and will come back with
  a better solution when the MIME and send layers have been overhauled.
  I.e., the real intent was to be able to specify that an embedded
  message/rfc822 is treated as a *unity*, and that's the goal.
  (Drop *rfc822-show-all*, 2013-01-23)
  [The manual will be adjusted in a different commit.]

- *rfc822-no-body-from_* has been renamed to *rfc822-body-from_*.
  It thus must be set explicitly.
  On the other hand it now catches all cases...
  (*rfc822-no-body-from_* -> *rfc822-body-from_*, 2013-01-23)
  [The manual will be adjusted in a different commit.]

- The new *charset-7bit* (defaults to US-ASCII) and *charset-8bit*
  (defaults to UTF-8) have been introduced.
  These are used if seven bit clean data is to be sent, and no
  *sendcharsets* are set or the convertion of all of them failed,
  respectively:

  - There is no functional change unless there is iconv(3) support.
  - There is no functional change unless you set them.
  (Introduce *charset-8bit* and *charset-7bit* variables.., 2013-01-18)
  [The manual will be adjusted in a different commit.]

  In addition the new *sendcharsets-else-ttycharset* variable can now
  be used to automatically use *ttycharset* as a *sendcharset(s)*,
  regardless of the new *charset-8bit* variable.
  (Add *sendcharsets-else-ttycharset* variable, 2013-01-24)
  [The manual will be adjusted in a different commit.]

  NOTE: before we apply charset conversion we now perform a string
  comparison to see wether character sets are identical.  If the strings
  match (case-insensitively), then *no* conversion is performed.
  This means that code like

    $ printf "LATIN1: \0376" | s-nail -Ssendcharsets= -s boom ./out.txt

  *succeeds* in an UTF-8 environment now, whereas older versions would
  fail with an "illegal byte sequence" error (unless the iconv(3)
  library of the system would not perform any conversion that seems
  superflous, of course).

  I thought about making this optional, but, in fact, if this would be
  done in an environment without iconv(3) support then the result would
  be equally corrupt.  And the way it is now we save the expensive and
  superflous conversions.  (See TODO for more.)

  Please *do* reread the manual section "Character sets".
  +++++++++++++++++++++++++++++++++++++++++++++++++++++++

- An attempt was made to improve MIME Content-XY: detection.
  It should be more RFC compliant, and just overall better :);
  a simple one-pass classifier cannot match libmagic(3), of course.

  This changeset removes support of the long obsoleted (4fee1ef,
  2005-01-06) *charset* variable, as well as for the
  *maximum-unencoded-line-length* variable that has been introduced in
  (48a652bd, 2005-07-26).

  For S-nail v14.0 it'll be no longer necessary to do

    $ tr -d '\015' < input | s-nail ...

  to transport files which use the $-DOS (terminal) newline (sequence).
  We still depend upon *sendcharsets* for a while, though.
  (Rewrite file-content classification.., 2013-01-02)

- The new *mime-counter-evidence* variable can be used to force
  a classification of non-text MIME parts (attachments) by their
  filename, i.e., a "reverse-classification" just as would be performed
  if S-nail(1) would itself *send* the file(name).  This can help
  against some stupid MUAs (Apple Mail?) that send .diff etc. files as
  `application/octet-stream' parts etc.

  At a later time this may become a valued option, causing a temporary
  save of unnamed attachments followed by a MIME classification of the
  file contents, followed by forced treatment as plain text if it seems
  to be human readable.  But not yet.  Just to warn you.
  (Add *mime-counter-evidence* variable.., 2012-12-29)

- The special "pipe-" command "@" can be used to force treatment of
  a MIME message part as plain text (e.g.,
  'set pipe-application/pgp-signature=@' will henceforth print those
  signatures inline and as plain text).
  (Introduce the special "@" "pipe-" command, 2012-12-27)

- The MIME types (as from mime.types(5)) will now be cached.  Before
  all possible sources would have been opened, read and parsed for each
  and every message part that required detection of the MIME
  Content-Type:.
  The new "mimetypes" command can be used to show or clear that cache.
  (Add mime.types(5) cache.., 2012-12-27)

- A small set of MIME types (template: ./mime.types) will now become
  compiled into S-nail(1), and be used as a fallback if there are no
  ~/.mime.types and/or no /etc/mime.types, or those didn't contain
  a matching type.  E.g., NetBSD 6 doesn't ship a default database.
  Also, file extensions will be matched case-insensitively (case of
  attribute values is not specified afaik?).
  (Introduce compiled-in mime.types(5).., 2012-12-21)

- The undocumented *charset7* variable was removed.

- The "Message X:" display leader has been changed and will henceforth
  be matchable via "^[-- Message \d+ -- \d+ lines, \d+ bytes --]:$".
  These lines can no longer be suppressed by setting the *quiet*
  option (which was yet possible for print and top, though undocumented).
  (Change "Message X:" display message.., 2012-12-20)

- When displaying multipart messages the "Part X:" introductional string
  has been changed; if the Content-type: header is not *retain*ed, then
  this string will include the part's type and size.  Ditto for
  Content-disposition: and a mentioned attachment filename.
  This is a first step only, for the final version the MIME and send
  layers will have to be adjusted.  But the string will be matchable via
  a "^[-- #.* --]$" regular expression from now on.
  (Change "Part X:" display message.., 2012-12-20)

- MIME boundaries in multipart messages are now handled better in that
  no boundary string should get through to the display.
 (Tweak MIME boundary detection.., 2012-12-20)

- A couple of long standing, even pre-Heirloom mailx(1) memory leaks and
  segmentation violations, most of them related to configurations
  without alloca(3) support, as well as one leak that i have introduced
  when i implemented RFC 4155 MBOX handling, have been fixed.
  But S-nail should now survive non-alloca(3) configurations.
  (*memtracer* topic branch.)

- The Base64 MIME handling has been rewritten completely.
  This was an urgent topic, because the old implementation (a) read in
  all lines of a base64 encoded text part, repeatedly resizing a string
  storage and repeatedly decoding that string until all the lines have
  been swallowed (i.e., or by accident the last decoded byte was
  a newline character, and that in turn may of course have fucked up for
  multi-octet encodings, dependent on the actual byte-order), (b) used
  function local static data to keep state in between multiple
  invocations, which messed up multi-byte/-octet encodings like this

    �5��ɽ���Aɥ����́��٥��������[lots of data follows]

  and (c) did not perform any error checking at all.
  The new one does not run into the problem that (a) tried to circumvent
  since leftover decoded data (as opposed to leftover *encoded* data) is
  transported along the call-chain for later use.  It adds a minimal set
  of error handling ('may now see "[Invalid Base64 encoding ignored]"),
  with more to become possible in later S-nail versions when the entire
  layers are reworked.  (Until then DOS newline sequences [CRLF]
  embedded into base64 will no longer be decoded to Unix LF newlines.)
  Base64 encoded lines will now be 76 characters long, as stated (as
  a maximum value) in RFC 2045, not 72 as before.

  The Base64 code core has been shamelessly stolen from NetBSD's
  Mail(1), and i guess it was the second time that this happened :=).
  (*base64-rewrite* topic branch; and reworked later on the *mime-cte*
  topic branch.)

- The string allocation strategy has been tweaked some more to, i think,
  a final version (regarding algorithm).
  In normal non-interactive send mode it should now no longer need any
  dynamic memory at all (unless some dozen recipients are specified).
  (Several other places still use normal dynamic memory, of course.)
  (*dope-stringdope-again* topic branch.)

- Support for NSS (Network Security Services) has been removed.
  I've never worked with it and are, regarding the complexity of
  network security, not willing to spend any time on it.
  SSL is installed on all systems i'm using and/or testing on by
  default, and so i've choosen to go this way.
  (It may be that sometime in the future S-nail will add support for
  libcurl(3) connectivity, and then it may happen that not only NSS
  support is reintroduced again, but also GNU TLS.  All of that applies
  to network connectivity only, however, not to S/MIME afaik.)
  (*drop-nss-support* topic branch.)

- I finally got a glue and understood that Sourceforge does (a) not
  support symbolic links and (b) doesn't like dots as regular parts of
  filenames.  This means that all this time the promised s-nail.tar.gz
  symbolic link did not work, and that s-nailv13.3.tar.gz wasn't
  accessible either (via the web interface).
  In the future S-nail(1) will not provide any more symbolic links (the
  Sourceforge website offers a "download latest" thing which seems to
  work), and use underscores in filenames -- s-nailv13.3.tar.gz has been
  renamed to s-nailv13_3.tar.gz.  The tags continue to use dot notation.
  Thanks.

- The *heirloom-plus* support branch has been removed.
  The code bases diverged a lot and even more to come.
  It doesn't make sense to put any effort in that.

v13.3, 2012-11-11
-----------------

- Configuration on UnixWare 7.1.4 will succeed (shell issue fixed).

- Even on DragonFly BSD the IMAP GSSAPI is now found
  (in /usr/pkg/include/krb5/gssapi/gssapi.h).

- Support for pkgsrc(7) systems and automatic integration of
  C_INCLUDE_PATH and LD_LIBRARY_PATH path configurations.
  Please see INSTALL.

- Fixes a mortally embarassing regression that the current maintainer
  introduced before i really knew what i was doing, in (If *record* is
  set, avoid writing dead content twice.., 2012-09-14).
  It hit users that send through a MTA and have *record* set; in this
  combination data would not have reached the MTA.
  Interested parties may read the comment in savedeadletter() (part of
  the changeset) or the (Fix MTA/*record* descriptor clash..,
  2012-11-10) commit log.

  Deepest apologies to tortured users from the current maintainer!

- RFC 4155 compatible MBOX file handling has been introduced, and so
  S-nail is now on par with (at least) NetBSD Mail in respect to this.
  It can be turned off with the new *posix-mbox* variable, which you may
  need to use since not all MUAs are capable to dig those MBOX files.
  E.g., less cutting-edge (.-) MUAs fail for this:

   |From - Thu May 10 20:40:54 2012
   |Date: Wed, 07 Nov 2012 11:48:30 +0100
   |To: super@duper.com
   |Subject: super1
   |
   |From me.
   |
   |From - Thu May 10 20:40:54 2012
   |Date: Wed, 07 Nov 2012 11:48:30 +0100
   |To: super@duper.com
   |Subject: super2
   |
   |>From - Thu May 10 20:40:54 2012
   |From - Thu May 10 20:40:54 2012

  I'm not completely happy since S-nail *does* still quote those lines,
  how rare they may be -- it *does* modify message content.  mutt(1)
  implements something more clever and that is quoted-printable encoding
  of the "F" from "From", when seen at the beginning of a line.
  This, when applied to just *any* "^From", will be a non-modifying and
  all-compatible solution.

- SEND_MBOX handling has been changed to discard any Content-Length: and
  Lines: headers when it rewrites a message by default.
  I know that mutt(1) generates them (why, after
  http://www.jwz.org/doc/content-length.html?).
  Anyway, S-nail does neither use nor manage them, so that any
  modification renders those fields invalid, and then it seems best to
  discard them anyway.
  You may turn the new behaviour off with *keep-content-length*.

v13.2, 2012-11-03
-----------------

The problem was that i really wanted to release on a 25th.
But i have been able to improve S-nail(1) some more, so that this is
possibly the first real release of it.  So i'll add only things that
have changed since v13 -- please see below for the complete picture.

- A new CONFIG=CUSTOM make directive was added, and the new user.conf
  variables WANT_SCORE and WANT_DOCSTRINGS have been added.  It is
  possible to create a floating-point free S-nail(1) now.
  Please see INSTALL.

- If a feature is disabled not even functions stubs should remain now.

- Many places which will work only with local filenames do now actually
  check that the target is a local filename.

- Space-separated lists should work again, at a few places at least.

- Tilde commands will be possible, even with -r.

- The *sendmail-progname* has been added after NetBSD 6 dropped the
  send-mail entry in mailer.conf(5), which broke S-nail(1).  Now users
  have an option.

- When editing messages via ~e or ~v file and pipe addressees will no
  longer be lost.

- If recipients occur multiple times spread over lists, i.e., To:, Cc:,
  Bcc:, then only one occurrence remains, and in the "highest-order"
  list.

- The "list" command prints the list alphabetically sorted (somewhat).

- The "help" and "?" commands take an optional argument that shows
  a synopsis string for the given command (unless WANT_DOCSTRINGS was
  false).

- String allocations are now more efficient.  The situation can still be
  improved.  However, for the first time Berkeley Mail(1) integrates
  harmonically into the system allocator, which may madvise(2) unused
  memory to the operating system as necessary and/or possible!

v13.1, 2012-10-25
-----------------

Well, a version number 13 is anyway an ugly thing...

  commit 4f534bb33b7c911272cc66a0e3a9e47b73ad8deb
  Date:   2012-10-25 20:46:07 +0200

      FIX MIME quoted-printable encoding (char cast)..
      
      (;-{
      Auauauauau!!
      
      Well, one of the things that have already been started in v13 is
      the turn from using "int" when working with 8-bit characters to
      "unsigned char" (and as long as we do not support wide
      characters).
      
      Unfortunately one very important piece of code, that is handling
      encoding to quoted-printable, still used integer instead of
      unsigned char, which caused an automatic extension cast to take
      place, and that resulted in a messed up output.
      Sorry!

v13, 2012-10-25
---------------

I want to give prominence to the following people that helped to improve
S-nail(1) during this development cycle, in order of appearance: Martin
Neitzel, Ezequiel Garzón, Björn Persson, Paul Vojta, and, especially,
John Dodson for warm words from beautiful Australia!  Many thanks also
to Christos Zoulas.

After i've officially forked nail(1) aka Heirloom mailx(1) as S-nail(1)
on 2012-09-18 i have been able to work five weeks almost fulltime on
S-nail(1) development.  The first three weeks can be characterized as
hectic fireworks here and there, but then it got better and i was able
to work more or less topic-centric.  In the meanwhile S-nail(1) is more
than 230 commits away from the Heirloom base--and drifting further apart.

S-nail(1) v13 is the first release of S-nail(1), but it was forked from
Heirloom mailx(1) 12.5 7/5/10 that arose from Berkeley Mail 8. unless
i'm mistaken.  What characterizes S-nail(1) v13?

- The build system has been reworked almost completely.
  It is possible to fine-tune which features should be present in the
  binary and which don't.  The name of the binary can be chosen, and
  that choice is reflected all through the manual and the template
  resource file.  The manual is always complete and thus may document
  features that are not supported by the actual binary, though.
  Please see INSTALL for more.

- Compiler warnings can now be used.  Please see the example WARN= flags
  in the Makefile, but '-Wall -Wextra -pedantic' should be silent though
  certainly insufficient to reflect the complex work of modern compilers.

- The following recipient address list combines some of the major
  improvements that have been made:

    <addr1@cdröm.de>  (bier) , ./file1,
    Steffen Smöregäs (Humbabä) <sauer@bäüer.de> (Hummpäa)    ,
         sabberlot@träbbel.de  ,  (bier2) <a2@bür2.de> ,
       a3@b3.de (bier3)  , <a4@b4.de> (bier4, und \"bier5\")  ,
    |cat > pipe1 ,   (bier 6) <a6@bür6.de>  ,   ./file2        ,
    (co\$mm1) abc1@düf.de (cö,bmm,2)   (co\"m\"m.3) ,
    co\$bmm1 \"c,ömm2\" co\"m\"m.3 <abc2@däf2.de>  ,  |cat > pipe2 ,
    moppel@höppel.org

  That, on a single line, may be given to ":m" or (quoted) on the
  command line, or to "~c" or whatever, and it will work as expected
  (well, everything else would be a bug..) and result in the following
  sendmail(1) invocation:

  SENDMAIL.SH
  <-i a2@xn--br2-hoa.de a3@b3.de a4@b4.de a6@xn--br6-hoa.de abc1@xn--df-xka.de abc2@xn--df2-qla.de addr1@xn--cdrm-7qa.de moppel@xn--hppel-jua.org sabberlot@xn--trbbel-cua.de sauer@xn--ber-qla4j.de>
  >>>>>>>>>>>>>>>>>
  Date: Thu, 25 Oct 2012 17:12:15 +0200
  To:
  Cc: Steffen =?utf-8?Q?Sm=C3=B6reg=C3=A4s?=
    =?utf-8?Q?_(Humbab=C3=A4)?= <sauer@xn--ber-qla4j.de> (=?utf-8?Q?Hummp=C3=A4a?=),
    sabberlot@xn--trbbel-cua.de, moppel@xn--hppel-jua.org,
    <addr1@xn--cdrm-7qa.de> (bier),
    co$bmm1 =?utf-8?Q?"c,=C3=B6mm2"?= co"m"m.3 <abc2@xn--df2-qla.de>,
    (co$mm1) abc1@xn--df-xka.de (=?utf-8?Q?c=C3=B6,bmm,2?=) (co"m"m.3),
    (bier 6) <a6@xn--br6-hoa.de>, <a4@b4.de> (bier4, und "bier5"),
    a3@b3.de (bier3), (bier2) <a2@xn--br2-hoa.de>
  Subject: Re: SubjectTest
  MIME-Version: 1.0
  Content-Type: text/plain; charset=us-ascii
  Content-Transfer-Encoding: 7bit

  body
  <<<<<<<<<<<<<<<<<

  So list parsing has been fixed, IDNA support has been added, and it is
  possible to mix pipe and file recipients *and* multiple thereof, and
  the result is still correct for *all* of them.
  I think this kind of list can be given wherever a user can directly
  enter such a list.  And i think all that is unique to S-nail(1).

- When writing back edited messages the target MBOX mailbox can no
  longer become "corrupted" when the trailing newline was removed during
  the edit.  Also affected FreeBSD and NetBSD mail(1).

- A security fix for CVE-2011-2895 was applied.

- The generated Message-Id: is now more human-friendly.

- The -h command line option has been dropped.  Use "-O -h XY" if your
  MTA really supports that.

- The -O and -r command line options no longer enforce a one-shot send
  mode, and instead persist for the duration of the entire session.

- Variables set via the -S command line option are now (un)set twice;
  immediately and after all the resource files have been loaded.

- Other new or changed options/commands, in order of appearance:
  recipients-in-cc, smime-sign-include-certs, quote-fold, stealthmua,
  add-file-recipients, write, rfc822-no-body-from_, rfc822-show-all,
  mail/Mail, idna-disable, idna-strict-checks, ??

- In the codebase itself an effort to reduce duplicate work and
  introduce caching, and to minimize the use of local variables, was
  started, but that is long term.  A lot of improvements here and there,
  too, like using the well MD5 optimization from Wei Dai, Chris Torek's
  hash algorithm for hash tables etc.

- Incredibly important: an heraldic animal was found: snailmail.jpg!

The full history can be inspected by issuing the git(1) command

  $ git log --reverse s-nail..s-nailv13

A new TODO has been introduced, and it is getting longer and longer.
Thanks.
