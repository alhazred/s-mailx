TODO reminder.

Release S-nail v20 on 2018-03-25, the 40th anniversary of Mail.
With a clean, conforming and efficient codebase, then.

Backward-compatibility breakers
-------------------------------

- Recipients specified on the command line should be added to those
  specified in the message when the -t option is set.

- The -q option makes me sad as it doesn't use *indentprefix* for the
  quoted file.  So either there should be -Q which does so, or -q should be
  changed.  Also see ~R below.
  [Note: i think i go for the latter.  Please complain.]

- At least optionally disallow silent discarding of invalid addresses,
  i.e., cause sending to be aborted if not all recipient addresses pass the
  validity test.

- Ditto if a resource file can't be found that has been explicitly set via
  environment variables there should be some feedback.

- I.e., it is fine to be silent unless an error occurs, but then please
  report errors and offer (in interactive mode) the possibility to act at
  a glance.

-- While there.  There should be some kind of "verbose" switch that - in
   interactive mode - also gives *positive* feedback, as in "added
   attachment X, charset Y", but without giving details about protocol
   delivery etc.

   [It is terrible that there is almost no feedback in the UI.  When
   i temporarily implemented a sorted cmdtab i've often used wrong commands,
   but got no feedback at all!  E.g., wanted to "undelete 14", first did "u
   14", then "und 14" and then realized my fault and did "undelete 14".
   *Nothing*.]

- POSIX says that, when written to DEAD: "If the file exists, the message
  shall be written to replace the contents of the file".  This is mentioned
  for ASYNCHRONOUS EVENTS, but it's the only description of what should be
  done in which way to DEAD.  savedeadletter() yet appends.  See ZOMBIE ,)

- Furthermore, *all* file operations yet append, even recipient target
  files are appended.  I don't know if this is really desirable behaviour,
  but i have not thought about that for real.  Maybe this should be at
  least configurable.

- It irritates me that a message with 5 visible lines but 115 header lines
  goes through the pager, even if i have *crt=*.
  P.S.: we could simply count the headers in addition?

- We should possibly get away of using command line utilities for
  compression.  (At least optionally?)  Instead we should link against
  zlib(3), bz2lib(3) and lzma(3), if found.  Or we may use dlopen(3)
  instead, if found, to avoid linking (though those libraries don't need
  much linker work unless actually used afaik, 'should look in detail).
  We should also drop lzw.c, it is used for the IMAP cache.

- We should maybe turn -~ into the meaning "force interactive".
  We should extend cc-test.sh, then, to test some interactive things.

Non-breakers
------------

- We need a "void" box that can be jumped to, i.e., a state in which no box
  at all is active.

  (schdir(): realpath() local files before leaving CWD.., 2013-01-08)
  did a first step to avoid "getting stuck" when the current folder becomes
  unaccessible.
  That is however only a command-specific workaround for a deeper design
  problem.

-- When a MBOX mailbox is removed while it is opened then changing the
  folder is not possible.  This is an inherent problem of the Berkeley
  Mail codebase, and we need to have a fully functional intermediate
  VOID box mechanism plus an object-based mailbox implementation to
  overcome it.

-- Also, when the folder is modified concurrently we should bail, or, in an
  interactive session, prompt the user what to do.

- IDNA decoding.  Needs a complete design change.

- Mail-Followup-To:.

- Make it possible to reply to/save/write/xy part X.Y[.Z] by allowing its
  specification directly, as in, e.g., ':w 1.2'.  If doing so on an
  embedded message/rfc822, e.g., a message embedded in a digest, it should
  be possible to reply to the very message in respect to its header fields,
  but (optionally?) keep the original Cc:'d.  (Parts by Martin Neitzel)

- mutt(1) quotes all text parts of a message, not only the first one!
  This should at least be optionally available.

- If pipes fail for part viewers then at least the usual PART X.Y should be
  shown, maybe even including some error message.
  I had 'set pipe-text/html="lynx -dump -force_html /dev/stdin"' but NetBSD
  does not have lynx(1), and i thought i've found a S-nail(1) bug.
  And so it was.

- I want to have a ~R tilde command that works like ~r except it performs
  quoting of the input just as ~m does.  Also see -q above.

- Offer the possibility to work with certificate fingerprints instead of
  full certificates, in equal spirit to the current maintainers S-Postman
  and Mercurial.  S-nail(1) could simply offer something in equal spirit to
  the formers --fingerprint, so that no other tool is necessary for
  certificate management (for at least secure transport).

- It would be nice if it would be possible to define a format string for
  *quote*, like 'set quote="format=some formats"'.
  In general the current approach is somewhat messy IMO.  I.e., it would
  make more sense to act rather like mutt(1) and as written elsewhere in
  this document, i.e., have some toggles that act on the display and use it
  for multiple modes (show/reply/forward etc.)
  Otherwise introduce commands which include all the headers plus, e.g.,
  "hreply" or "freply", and then the ditto series, i.e., "hReply" ...

-- This would also mean that interactive message editing would work
  accordingly.  PleasE!

- Command line editing should gain possibility of context sensitive tab
  completion.

-- Note that the TTY is sick.  If ^C on input it simply jumps to next
   input, instead of saying "Interrupted, one more to die hard" or
   something (talking about ~@ charset selection prompts in particular).

- For those who use S-nail(1) only with a MTA it may be desirable to have
  some "smopts" expansion mechanism in equal spirit to NetBSD mailx(1).

- Maybe there should be an additional ZOMBIE directive that is served in
  equal spirit to DEAD, but that could be a valid MBOX... ?
  What i want is a *real* resend, best if possible from command line.
  Meaning, also the possibility to postpone a message.  In general.

- POP3 doesn't support "newmail" for real.  If implemented, should it sync?
  Look at POP3 impl. in general..

- Having a newsreader would be a really cool thing.  (RFC 977 and 2980)

- There should be a way to ignore the From_ line, as opposed to the From:
  line, i.e., distinctively.

- There should be a variable that controls wether leading and trailing
  empty lines of parts and/or messages as such should be printed or not.

- RFC 2387: multipart/related.

- rfc2384.txt etc.  I.e., Much better URL support.

- printhead()/hprf(): support %n newline format (%t tab?).
  Make it possible to use the *datefield* algorithm for plain From_ derived
  dates (needs a From_ parser, i.e., strptime()-alike).
  Once we have that, rename *datefield-markout-older* to
  *date-markout-older* ??
  Note that NetBSD's mail(1) has some other nice things.
  Note also that our code is quite unflexible.

-- NetBSD's mail(1) has nice *indentprefix* and *indentpostscript*
   variables (though prefix and appendix or prefix and suffix, but..).
   Note that our code is quite unflexible.

- The "top" command should honour ignoretab, or there should be a very
  special "top" ignoretab.  It simply doesn't make sense to "top" 5 lines
  when all that you get are Received: lines...

- In the very end it is not that hard to add (optional) MTA
  functionality at a most simple level.
  Use sqlite for aliases (and possibly cache), then.

- We should support IMAP compression over the wire.

Low-Level
---------

- Improve name extraction rules.  And field parsing.  There
  are structured and unstructured fields.  There are quoted pairs and
  comments etc.  Rewrite the entire parsing mechanism to comply to RFC
  5322, and try to merge all those many subparsers around in the codebase,
  and accordingly.  So much duplicated work ...
  Name parsing has been improved a bit for v13, but it's still broken.
  yankword(), *extract(), etc.: RFC 5322 says that comments in address
  fields SHOULD NOT be used (mutt(1) maps them to full name-addr forms if
  approbiate, even if that actually changes content!!?), and that full
  name-addr SHOULD be used.  Our functions are yet quite silly (i.e.,
  leading comments remain, as in "(bier2) <a2@b2.de>", unless the address
  doesn't come in angle brackets, trailing go away, as in "<a6@b6.de>
  (bier6)", that becomes "<a6@b6.de>").
  Something silly like
    (co$mm1) abc@däf.de (cö,mm,2)   ('c'o"m"m.3)
  Should eventually become
    co$mm1 cö,mm,2 'c'o"m"m.3 <abc@xn--df-via.de>
  on the display, or, with IDNA decoding (and thus rather unlikely)
    co$mm1 cö,mm,2 'c'o"m"m.3 <abc@däf.de>
  It should NOT become this mutt(1)ism:
    "co$mm1 cö,mm,2 'c'omm.3" <abc@däf.de>
  Or?

-- Think about a name bypass hashmap cache, and whenever we have to skin or
   nalloc() or whatever, look in there.  Maybe even an additional link for
   non GFULL(/GSKIN) and fully skinned struct name objects.
   The amount of duplicated work in this codebase is frustrating, but the
   real healing would make necessary a complete rewrite of the name handling!
   Such a cache would work without touching the current code flow ... or
   allow a smooth transition to a new one anyway.

++  NOTE: 'alternates' tracking happens BEFORE we enter composing, this
    means that an account switch during message composing will NOT cause
    reevaluation of all that very very clumy
    elide/delete_alternates/gexpand/is_myname etc. handling.

- Think about replacing the IMAP cache with an SQLITE3 interface.
  Or rewrite it.  Error handling etc. etc. is peculiar.

- The char classification stuff can be improved; currently each character
  has exactly one classification bit set, even if multiple would apply
  (e.g., HT=\t == CNTRL|SPACE|ASCII|BLANK).  This would allow better
  testing using our own classification functions in quite some places.

- The quoted-printable Content-Transfer-Encoding: supports soft linebreaks;
  it happens that a lot of mailers (Apple Mail?, Microsoft Word, Yahoo!
  Webmail) create HTML parts which solely consist of a single line,
  created via soft linebreaks.
  To handle such mess we need to be able to break out of the input-line ==
  output line relationship that is still fixated in the codebase.
  I.e., it is not even sufficient to convert "rest" into an array, but best
  would be if we would be able to sequentially work what we have, and
  detect when it is safe to "dump that out".
  This MUST be part of the send/mime layer rewrite in 15.0.

-- In v15.0, when we can address attachments of a message individually,
   it would be nice to provide even more access, just like nmh(1) does
   (Johan Commelin: Are s-nail and mh related?).

- I want a clean PTF interface for the actual layers.  There should be no
  switch() statements around that test for the type of BOX that is
  currently open.  Especially important for possible NEWS support, but the
  code is a mess in general...

- I would like to see that compilation with a C++ compiler is possible,
  though that would be a long way and be especially problematic due to the
  (C ish) way enums are used.

- I never used anything but the *datefield* option, and it would really be
  nice if the date strings would be parsed off into some 16 byte or what
  storage when about to producing the summary, so that it would be directly
  available and there would be no need to reread the mail.  Moreover, or
  even more than that - the m_date field exists and should possibly simply
  be init, at least in these cases.  (P.S.: this doesn't contradict the
  statement somewhere else in this file that the structure should be
  slacked; simply use multiple thereof or so)

- All error messages should not go to stderr but instead we should add our
  own n_warn() family and use that.  In the background we should have
  a ring of error messages (oldest fall off), and a command that is capable
  to display the ring.  The command loop should recognize whenever an error
  happened during the last command, and print something like "XY errors
  occurred", followed by a (truncated as necessary) error report.
  It simply doesn't make any sense to print errors on stderr if normal
  output goes to stdout and scrolls it off the screen.
  Note that yet some errors messages still go to stdout.

- It would be very nice if it would be possible to have
   account-specific macros that will be lost when a user switches off
   an account.

-- It would also be very nice if we could define macros while defining
   account, i.e., recursive definition of macros...

- At some later time extend the logic behind -# -- it should not have
  a current folder, but start in VOID mode (...), and unless one is
  explicitly chosen..  We need a reliable batch mode.

- (Support for mailcap files?  As of RFC 1524?  Unlikely.  Though the
  % expansions would be very helpful, especially once we can address
  individuals parts as of v15.0!)

- After I/O layer rework we should optionally be able to read RSS
  (Atom?) feeds -- Expat should be available almost everywhere and
  should be able to parse that?
  Atom is harder because it may support html+.
  I mean, yeah, it's stupid, but we could fill in header fields with
  dummies and still use S-nail to look into the separated feeds as if
  they were mail messages; anyway i would like to save me from using too
  many tools -- three seems reasonable.

- Add TODO notes for those RFCs:
  RFC 5322 - The basic format of email messages.
  MIME (Multimeda) email extensions
  RFC 2405 - The format of MIME message bodies.
  RFC 2406 - Common multimedia types.
  RFC 2017 - URL External-Body Access-Type
  RFC 3676 - Updates to the text/plain MIME type and extensions for flowed
    text (format=flowed).   (Martin Neitzel)
  RFC 2407 - Encoding of non-ASCII text in message headers.
  RFC 2183 - The Content-Disposition Header
  RFC 2231 - Encoding of character set and language information in MIME
    parameter values.
  SMTP (Simple Mail Transfer Protocol)
  RFC 5321 - Simple Mail Transfer Protocol.
  RFC 6409 - Message Submission for Mail
  RFC 4954 - SMTP Authentication
  RFC 3207 - SMTP over TLS
  RFC 6152 - SMTP Service Extension for 8-bit MIME Transport
  Post Office Protocol (POP)
  RFC 1939 - Post Office Protocol v3
  RFC 2449 - POP3 Extensions (including SASL)
  RFC 2595 - TLS for POP3 (among others)
  Security
  RFC 4422 - Simple Authentication and Security layer (SASL)
  RFC 5246 - Transport Layer Security (TLS)
  RFC 977 -> 3977 - Network News Transfer Protocol
  RFC 1036 - Standard for USENET Messages
  RFC 2980 - Common NNTP Extensions

- This is how the codebase has to be reworked in respect to signals and
  jumping:

  1. We introduce some environment/carrier structs: struct eval_ctx,
     struct cmd_ctx, (struct send_ctx).  All of these form lists.
     eval_ctx gets a new instance every time evaluate() is entered; for
     the interactive mode, commands() instantiates an outermost eval_ctx
     that "cannot be left".
     cmd_ctx knows about the eval_ctx in which it is was created; it is
     created for each command that has an entry in cmd_tab and is passed
     as the new argument of these kind of functions.
     (send_ctx is the carrier for the MIME and send layer rewrite.)
  2. We'll get a signal manager.  This is a global layer which is the
     sole object-in-charge for signals.  We'll install a complete set of
     handlers once -- those will only set has-occurred bits.
     All interested parties have to peek at the signal manager when they
     are in the position to deal with signals, via a series of
     "ha(s|ve)_occurred", "needs_action", "would_raise" or whatever, as
     well as "doact".
  3. We need a sort of non-local return, everything else would require
     a totally different way of programming.  Also, non-local returns
     are not *that* bad, generally speaking.  We'll be easy and add the
     possibility to define a jump target location in eval_ctx and
     cmd_ctx, by peeking at the signal manager (for object design
     reasons, though done by a macro, say), just like saying "i need to
     have the chance to perform some actions shall a jump be necessary".
  4. So, somewhere deep down the still recursive codebase, shall the
     necessity to honour a jump request occur, we peek the signal
     manager to "unroll" the current cmd_ctx/eval_ctx chain(s), which
     will result in none-to-multiple jumps to locations which require
     cleanup actions, ultimately ending in the non-leavable commands()
     eval_ctx or whatever.
  6. Hot: we save us from thousands of syscalls, and get rid of the
     fucking sig* shit.  It rhymes, it rhymes :)
     Should we even be able to go the non-blocking select(2) way in the
     end -- that would be fantastic!

TODO S-nail 14.7:
-----------------

- Deal with faulty message selection that may occur when selecting threads
  via & (when at least mixed with other selectors).

-- Also (?same problem?) the thread sort doesn't get

    [A is deleted]
    B answers A
      C answers B
      D answers B
    E is unrelated
    F answers A

  The current sort fails to recognize that F and the thread starting at
  B are related, which results in a mess.

- Make *password* and *password-USER@HOST* global, introduce
  *PROTOCOL-auth-password* and *PROTOCOL-auth-password-USER@HOST*.
  Then, drop smtp_auth_var(), and change lookup_password_for_token() to
  work like (PROTOCOL, user,host|TOKEN) -- *password* is a global override,
  only if that is not set lookup protocol specific.
  Use that single function from everywhere.

- Change **use-starttls* to the opposite.  I.e., CAPA or whatever, if TLS
  is supported, use automatically.  *UNLESS* explicitly disabled.

- NOTE: we do not really support IPv6 sofar in that we are not prepared to
  deal with IPv6 addresses.
  Introduce an URI abstraction structure in 14.5, and start using it, i.e.,
  _pop3_user() and, very important, sopen().
  Note this shit software use a lot of places which mess around...

- The account command involves a lot of code but it's only difference to
  define is that a "fi" is executed.  If we would have the possibility to
  explicitly jump to VOID boxes, we could use QUIT->FOLDER instead of
  FOLDER[OK? -> QUIT], and then it'd be up to the use to simply use a "fi"
  at the end of a define.  Or so.
  See above for more on account/define though.

-- If *folder* is set to an IMAP box, and we're about to "mbox" data to
   there, and we're currently on a POP3 server, and the connection fails,
   we're completely lost and cannot even interrupt...

- mutt(1) dotlock ..., "mbox" command doesn'T work?

- ARGH!  Should `folders' auto-login if *folder* is an IMAP account that is
  not active?  Why does _expand() use *mailname* to expand `@', not
  getfold() (care: res may point into cbuf, savestr() or so!).
  Why does demail() etc. treat *mailname* as a file (more or less), why do
  we need *mailname* at all;  we should have Folder objects, multiple of
  which concurrently, one the active; a Folder may not become *folder*
  unless it has write (store) capabilities).  Maybe then `mbox' works fine
  if connected to a POP3 server with a *MBOX* on an IMAP account that yet
  never was connected and needs to read a password on the terminal before
  the login works ... note the latter situation yet kills us since i think
  INT is blocked during all that ;-((

- I had a connection collapse during a POP3 download, and neither was
  there a chance to get access to the 22 yet downloaded mails (after
  five minutes of waiting followed by CNTRL-C), nor did the layer
  recognize this very well (got myriads of `POP3 connection already
  closed.' messages, btw., the thirty-something messages which were not
  yet downloaded caused (after CNTRL-C) this:

    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
     U 23                    Thu Jan  1 0    /    0
    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
    POP3 connection already closed.
     U 24                    Thu Jan  1 0    /    0

  i had to switch off and back).  At least we didn't crash.
  Thereafter, still very unstable connection, i tried to login again:

    ? fi xpop
    Resolving host pop.gmail.com . . . done.
    Connecting to 173.194.70.109:pop3s . . . connected.
    Comparing DNS name: "pop.gmail.com"
    POP3 connection already closed.
    +OK Gpop ready for requests from XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
  [..nothing!..]
    ^CInterrupt
    ? fi %
    "/private/var/mail/steffen": 0 messages
    ? fi xpop
    Resolving host pop.gmail.com . . . done.
    Connecting to 173.194.70.109:pop3s . . . connected.
    Comparing DNS name: "pop.gmail.com"
    ? fi
    ? fi
    ? fi

  Can of worms.

- Add a value-duplication command, i.e.,
    clone _x header
    unset header
    ...
    clone header _x
    unset _x

- Add a boolify() function, so that things like `localopts' and yorn()
  may be less strict on user input

- Ensure that `.' and EOF on a line works with all TTY modes (*ignoreeof*
  relationship, too)!  EOF conditions in general!

-- NCL / current expand-on-tab: fexpand() should take additional size_t* to
   store the number of the results OR should "return char** array", so that
   individual results can be addressed.
   Then we could simply print "\nALL-RESULTS\n" and NOT expand the current
   line if the result is ambiguous, i.e., we have more than one possible
   expansion.
   However, we would then need something to print the results page-wise,
   in case we have so many of them that they don't fit on the screen.
   ...  Etc. ...

- IMAP: if i `d' a message then this is a local change (in the meanwhile);
  yet, when i `u' it, that will go through the server, needlessly.

- I got an email in base64 that obviously used CRNL line endings, and once
  i've replied the CR where quoted as *control* characters.
  Get rid of those (kwcrtest.mbox; may be hard to do everywhere for some
  time). (2013-08-06)

- edit.c doesn't do NEED_BODY (yeah, IMAP won't work anyway).

- Some (configurable?) verbosity for certificate validation.
  See, e.g., 'curl -v' output, which is quite nice (not only in respect
  ot certificates).
  (Martin Neitzel)
  Rework certificate handling to match RFC 6125.

- Stuff
  .. s-nail </dev/null should work interactively when STDERR_FILENO is
    a terminal!  (Builtin editor; how do editline and readline work?
    should this be documented?  What does NetBSD Mail do?  Should we NOT
    be interactive??  POSIX says for sh(1) (APPLICATION USAGE): 'sh
    2>FILE' is not interactive, even though it accepts terminal input.)
  . Automatically track message attachments when switching off the
    folder.
    NOTE: 'alternates' tracking happens BEFORE we enter composing, this
    means that an account switch during message composing will NOT cause
    reevaluation of all that very very clumy
    elide/delete_alternates/gexpand/is_myname etc. handling.
    We REALLY need an object based rework of all that.
  . It would be cool if ghosts, shortcuts, alternates could
    (optionally?) be tracked via localopts.
    (Additional entry on xy-local xy somewhere above)
  . The spam* series (spam.c:_spam_action()) should abort if the command
    execution failed, instead of iterating the entire list.  Look into
    that.
  . DESTDIR= should not be taken into account when deciding wether
    a rebuild is necessary (not wrong to give that to Gaetan Bisson).
  . Just like the RFC 3676 link above, it would be nice if it would be
    somehow possible to recognize links in a document; i don't know yet
    how this could be achieved without loosing formatting information (i
    mean, we could enable this and inject terminal colour sequences, but
    one should be able to say 'follow link x', starting an action
    handler, and the 'x' must come from somwhere - simply injecting
    '[NUMBER]' references distorts visual).  Anyway, it's just a filter
    that recognized the usual <SCHEME:/> stuff, and of course we can
    simply have a buffer which records all such occurrences, so that
    user can say '? xy NUMBER', but without the context it soon gets
    hard.
  . TTY layer: the tc*() family may fail with EINTR, which MUST be
    handled; setting also generates SIGTTOU when we're not in foreground
    pgrp, so we better deal with all that and ENSURE WE GET THROUGH when
    resetting terminal attributes!
  . Remove all occurrences of mbtowc() with mbrtowc(); temporarily add (some)
    global mbstate_t objects until the send / MIME layer rewrite is done and
    has the carrier.  Use flip states and add aux funs with only update the
    state+toggle on success -- CURRENTLY MBTOWC FAILURES ARE PRACTICALLY NOT
    HANDLED!!
  . Ypnose (linuxien AT legtux DOT org) pointed out that for the IMAP
    cache we have some kind of UID validity check -- couldn't that be
    used to perform some kind of automatic reconnection when we get that
    much-too-frequent connection breaks in IMAP mode??
    Also, and also for POP3, don't let the ALARM based (ugh!  I'm
    starting to dream wet from select(2), almost truly) timer blindly
    tick, but restart it with a full interval when we did regular
    conversation with a server.  Don't forget the SSL timeouts (300
    seconds) and their interaction with normal (user) keepalives.
    Add a global *keepalive*, add *keepalive-USER@HOST*.  (Add and use
    a generic, single function to get the value for either protocol.)
  . HAVE_HISTORY plus: for WANT_EDITLINE and WANT_READLINE the
    mk-conf.sh yet always tests anything, i.e., we could fail due to
    history related stuff even though the user doesn't WANT_HISTORY.
  .. We should in fact convert our NCL history to a shared history
     implementation, and only hook editline(3) and readline(3) so that
     ^R and Cursor-(Up|Down) work as expected everywhere.
     Like that we would have duplicate elimination for readline(3), too.
  .. tty_addhist() should take a struct str.  Anyway, evaluate() should
     enter a history entry if the caller allows so, and it should trim
     also trailing whitespace; also, the expanded command should be
     stored, not the abbreviation, so that 'sst' and 'sstats' will no
     longer produce two separate entries.
  . getprompt() is not multibyte safe in that it should mbrtowc() before
    calling expand_shell_escape() (i.e., only call that if ASCII,
    otherwise pass through if fits as such).
  . Make S/MIME an option separate of SSL/TLS
  . pop3,mime_cte +++: \r,\n -> \015,\012, to avoid ANY problems..
  . send.c:_print_part_info(): the filename is truncated to a maximum of
    25 characters, which of course may mess up multibyte encodings!
    We need a multibyte safe clamp function, even if this means that
    an already encoded string is again parsed...  We can take advantage
    of UTF-8 here, however.
    FURTHERMORE: don't go and separate ISO C90 Amend. 1 and wcwidth(3);
    only support wide and multibyte stuff if we have them all.
    Alternatively we could support ONLY UTF-8 locales via ISO C90 and
    implement our own wcwidth(3) IFF it's only the latter is missing.
    Though that sounds crappy.

    v14.7 MUST use only mbrtowc() and have solved all these multibyte
    problems (that i've introduced, mostly, and mostly for new
    features).  It has to last for well over a year!
  . which_protocol(), *newmail* mechanism, displayname, mailname: all of
    this <rude>SHIT</rude> must be rewritten completely and can be
    overcome by an object-based mailbox implementation that carries all
    the necessary state (user given path, expanded realpath(3),
    abbreviated display path, box-protocol, etc.).  Once we have this,
    we may as well also re-introduce automatic detection of compressed
    file-based folders based upon .gz/.bz2/.xz extension.

    If not mentioned somehwere else: struct message should be splitted
    into a tree of objects, with a base class that has as few fields as
    possible; the global *message should be a deque, only accessible via
    iterator; it should store pointers to (the actually used subtype of)
    message structures instead; i.e., for maildir boxes the path is yet
    allocated separately, then it could be part of the message object,
    etc.
  . Drop support for *autoinc* in favour of *newmail* -- mention that
    i have forgotten to mention that it's legacy in 14.5.2 release
    notes.
  . Given how many temporary files we use, it would make sense to
    support a reusable single temporary file, as in singletmp_take() and
    singletmp_release(), where singletmp_release() would close and thus
    drop the file if it excesses a specific (configurable) size, and the
    mainloop tick would close it (after X (configurable) ticks))
    otherwise.  I guess this would improve performance for searching
    etc. etc.
  . Searching code *could* perform a prepass, joining stuff together,
    dropping useless cases etc.
    But anyway: if there are multiple search expressions, it shouldn't
    be an error if at least one of them matches at least one message.
  . catset(3) is plain shit, and ever was.  Remove IDs from all tr()s,
    use GNU tools for extraction etc., and write a simple helper program
    which converts these files to a serialized hashmap, just like we did
    for the okeys (and *exactly* so); add a config check wether the ({})
    extension is supported and finally use that for some ({static char
    const *tr_res;}) injection optimization, then.  (Think SFSYS)
  . Searching body/text yet includes headers from attachments and
    attachment data.  This is shit.  :)
  . Btw.: (with IMAP) when opening a folder the hook gets executed after
    the flags but before the headers are loaded, but for `newmail' it is
    *after* the headers have been loaded.
  .      /* TODO *batch-exit-on-error*: sourcing and loading MUST BE FLAGS!
          * TODO the current behaviour is suboptimal AT BEST! */
  . there MUST be a way to specify that a single SPECIFIC box has to be
    opened readonly.  only the global -R flag is NOT ENOUGH!
  . the "nifty" unregister_file()->_compress() mechanism that even
    shovels '-Sfolder=imaps://user1@localhost -Srecord="+Sent Items"'
    *records* calls clearerr() on the descriptor before performing it's
    action anyway.  when we really make it even to the I/O rewrite, it
    should be possible to dis-/allow such -- it doesn't make sense to
    add something faulty to whatever was not faulty before!
  . The message from Andy Switala on nail-devel made me think about some
    mechanism that invokes a macro after a message has been sent.
    Unless macros can have args (or do we introduce $*/$@/$1..).
    Even if the codebase will at some future time be stable and really
    reliable, sending a message via multiple channels will never be
    atomic, so that it would make sense for a user to be able to restore
    *the complete message* in a save place if any of the sends failed,
    but to remove it from our temporary place otherwise.  A simple
    version of this would be a matter of five minutes, but since
    mightrecord() may internally (via _compress()) instantiate
    a complete IMAP session and try to send incomplete data etc.,
    and all that may jump, i refrained from doing so.

vim:set fenc=utf-8:s-ts-mode
