#!/bin/sh

#
# Sccsid @(#)makeconfig	1.11 (gritter) 7/10/04
#

tmp=___build$$
tmp2=___tmp$$
out=config.h
log=config.log
lib=LIBS

make="${MAKE-make}"

exec 5>&2 >$log 2>&1

rm -f $out $lib
echo "\
/*
 * Auto-generated by $0.
 * Changes are lost when $0 is run again.
 */
" >$out
echo "
# Auto-generated by $0.
# Changes are lost when $0 is run again.
#
# need one non-empty line
 
# to make grep happy
">$lib

trap "rm -f $out $lib; exit" 1 2 15
trap "rm -f $tmp.? $tmp $tmp2.? $tmp2" 0

msg() {
	fmt=$1
	shift
	printf "*** $fmt\\n" "$@"
	printf "$fmt" "$@" >&5
}

compile_check() {
	topic=$1
	define=$2

	echo '************************************************************'
	msg "checking $topic ... "
	echo "/* checked $topic */" >>$out
	rm -f $tmp.o
	echo '*** test program is'
	tee $tmp.c
	#echo '*** the preprocessor generates'
	#$make $tmp.x
	#cat $tmp.x
	echo '*** results are'
	if $make $tmp.o && test -f $tmp.o
	then
		msg "okay\\n"
		echo "$define" >>$out
		return 0
	else
		echo "/* $define */" >>$out
		msg "no\\n"
		return 1
	fi
}

link_check() {
	topic=$1
	define=$2
	libs=$3

	echo '************************************************************'
	msg "checking $topic ... "
	echo "/* checked $topic */" >>$out
	cp $lib $tmp2
	rm -f $tmp $tmp.o
	echo '*** test program is'
	tee $tmp.c
	#echo '*** the preprocessor generates'
	#$make $tmp.x
	#cat $tmp.x
	echo '*** results are'
	if $make $tmp LIBS="$libs" && test -f $tmp
	then
		msg "okay\\n"
		echo "$define" >>$out
		echo "$libs" >$lib
		cat $tmp2 >>$lib
		return 0
	else
		msg "no\\n"
		echo "/* $define */" >>$out
		return 1
	fi
}

link_check 'if a hello world program can be built' <<\! || { rm $out; exit 1; }
#include <stdio.h>

/* check for old style functions without explicit parameters */
int main(argc, argv)
	char **argv;
{
	puts("hello world");
	return 0;
}
!

compile_check 'for <alloca.h>' '#define HAVE_ALLOCA_H' <<\!
#include <alloca.h>
!

link_check 'for alloca()' '#define HAVE_ALLOCA' <<\!
#include "rcv.h"
int main(void)
{
	alloca(1);
	return 0;
}
!

compile_check 'for ssize_t' '#define HAVE_SSIZE_T' <<\!
#include <sys/types.h>
#include <unistd.h>
int main(void)
{
	ssize_t	i = 3;
	write(1, "foo", i);
	return 0;
}
!

link_check 'for snprintf()' '#define HAVE_SNPRINTF' <<\!
#include <stdio.h>
int main(void)
{
	char	b[20];
	snprintf(b, sizeof b, "%s", "string");
	return 0;
}
!

link_check 'for iconv functionality' '#define HAVE_ICONV' <<\!
#include <iconv.h>
int main(void)
{
	iconv_t	id;

	id = iconv_open("foo", "bar");
	return 0;
}
!

link_check 'for wctype functionality' '#define HAVE_WCTYPE_H' <<\!
#include <wctype.h>
int main(void)
{
	iswprint(L'c');
	towupper(L'c');
	return 0;
}
!

link_check 'for mbtowc()' '#define HAVE_MBTOWC' <<\!
#include <stdlib.h>
int main(void)
{
	wchar_t	wc;
	mbtowc(&wc, "x", 1);
	return 0;
}
!

link_check 'for setlocale()' '#define HAVE_SETLOCALE' <<\!
#include <locale.h>
int main(void)
{
	setlocale(LC_ALL, "");
	return 0;
}
!

link_check 'for nl_langinfo()' '#define HAVE_NL_LANGINFO' <<\!
#include <langinfo.h>
int main(void)
{
	nl_langinfo(DAY_1);
	return 0;
}
!

link_check 'for mkstemp()' '#define HAVE_MKSTEMP' <<\!
#include <stdlib.h>
int main(void)
{
	mkstemp("x");
	return 0;
}
!

link_check 'for fpathconf()' '#define HAVE_FPATHCONF' <<\!
#include <unistd.h>
int main(void)
{
	fpathconf(0, _PC_PATH_MAX);
	return 0;
}
!

link_check 'for wordexp()' '#define HAVE_WORDEXP' <<\!
#include <wordexp.h>
int main(void)
{
	wordexp((char *)0, (wordexp_t *)0, 0);
	return 0;
}
!

compile_check 'for <arpa/inet.h>' '#define HAVE_ARPA_INET_H' <<\!
#include <arpa/inet.h>
!

cat >$tmp2.c <<\!
#include "config.h"
#include <sys/types.h>
#include <sys/socket.h>
#include <netdb.h>
#include <netinet/in.h>
#ifdef	HAVE_ARPA_INET_H
#include <arpa/inet.h>
#endif	/* HAVE_ARPA_INET_H */

int main(void)
{
	struct sockaddr	s;
	socket(AF_INET, SOCK_STREAM, 0);
	connect(0, &s, 0);
	gethostbyname("foo");
	return 0;
}
!

<$tmp2.c link_check 'for socket functionality in libc' \
		'#define HAVE_SOCKETS' ||
	<$tmp2.c link_check 'for socket functionality in libnsl' \
			'#define HAVE_SOCKETS' '-lnsl' ||
		<$tmp2.c link_check \
			'for socket functionality in libsocket and libnsl' \
			'#define HAVE_SOCKETS' '-lsocket -lnsl'

#link_check 'for IPv6 functionality' '#define HAVE_IPv6_FUNCS' <<\!
##include "config.h"
##include <sys/types.h>
##include <sys/socket.h>
##include <netdb.h>
##include <netinet/in.h>
##ifdef	HAVE_ARPA_INET_H
##include <arpa/inet.h>
##endif	/* HAVE_ARPA_INET_H */
#
#int main(void)
#{
#	struct addrinfo	a, *ap;
#	getaddrinfo("foo", "0", &a, &ap);
#	return 0;
#}
#!

link_check 'for OpenSSL' '#define USE_SSL' '-lssl -lcrypto' <<\!
#include <openssl/ssl.h>
#include <openssl/err.h>
#include <openssl/x509v3.h>
#include <openssl/x509.h>
#include <openssl/rand.h>

int main(void)
{
	SSLv23_client_method();
	return 0;
}
!

exit 0
